<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light">
<link rel="icon" href="/static/anyai/assets/AnyAI_Logo_For_Loading.png">
<title>AnyAIVideoSummarizer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='anyai/anyai.tokens.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='anyai/anyai.components.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='anyai/anyai.utilities.css') }}">
<script defer src="{{ url_for('static', filename='anyai/anyai.js') }}"></script>
<script defer src="{{ url_for('static', filename='anyai/queue-manager.js') }}"></script>
<style>
  .page { padding: var(--anyai-space-08) 0 var(--anyai-space-10); }
  .nav a.is-active { font-weight: 700; }
  #log-container { height: 320px; overflow-y: auto; font-family: var(--anyai-font-mono); font-size: 0.9rem; white-space: pre-wrap; background: var(--anyai-surface-alt); padding: var(--anyai-space-04); border-radius: var(--anyai-radius-md); border: 1px solid var(--anyai-border); }
  #history-list li { cursor: pointer; border: 1px solid var(--anyai-border); border-radius: var(--anyai-radius-sm); padding: var(--anyai-space-03) var(--anyai-space-04); transition: background .15s ease; }
  #history-list li:hover { background: var(--anyai-surface-alt); }
  .queue-header { display:flex; justify-content:space-between; align-items:center; gap:var(--anyai-space-04); }
  .queue-header-actions { display:flex; gap:var(--anyai-space-02); }
  .queue-card .card-body { display:flex; flex-direction:column; gap:var(--anyai-space-04); }
  .queue-content { display:flex; gap:var(--anyai-space-04); flex:1; min-height:220px; }
  .queue-list-container { flex:1; display:flex; flex-direction:column; gap:var(--anyai-space-03); overflow:hidden; }
  .queue-details { flex:1; display:flex; flex-direction:column; gap:var(--anyai-space-03); }
  .queue-details textarea { flex:1; resize:vertical; font-family:var(--anyai-font-mono); font-size:0.85rem; }
  .queue-details a { word-break:break-all; font-size:0.85rem; color:var(--anyai-color-primary-600); }
  .queue-controls { display:flex; flex-wrap:wrap; gap:var(--anyai-space-02); }
  .queue-item { border:1px solid var(--anyai-border); border-radius:var(--anyai-radius-sm); padding:var(--anyai-space-03) var(--anyai-space-04); background:var(--anyai-surface); display:flex; flex-direction:column; gap:var(--anyai-space-02); cursor:pointer; }
  .queue-item.is-active { border-color:var(--anyai-color-primary-500); box-shadow:0 0 0 1px var(--anyai-color-primary-300); }
  .queue-item-sub { display:flex; justify-content:space-between; gap:var(--anyai-space-02); color:var(--anyai-text-muted); font-size:0.85rem; }
  .queue-item-type { font-size:0.75rem; color:var(--anyai-text-muted); text-transform:uppercase; letter-spacing:0.04em; }
  .queue-status { display:inline-flex; align-items:center; gap:var(--anyai-space-02); padding:0 var(--anyai-space-02); border-radius:var(--anyai-radius-pill); font-size:0.75rem; text-transform:uppercase; letter-spacing:0.03em; }
  .queue-status-queued { background:var(--anyai-color-info-100); color:var(--anyai-color-info-700); }
  .queue-status-running { background:var(--anyai-color-success-100); color:var(--anyai-color-success-700); }
  .queue-status-paused { background:var(--anyai-color-warning-100); color:var(--anyai-color-warning-800); }
  .queue-status-cancelled { background:var(--anyai-color-danger-100); color:var(--anyai-color-danger-700); }
  .queue-status-completed { background:var(--anyai-color-neutral-200); color:var(--anyai-color-neutral-700); }
  .queue-card .btn.btn-text { padding:0 var(--anyai-space-02); }
</style>
</head>
<body>
<header class="anyai-header">
  <a class="brand" href="{{ url_for('main_page') }}" aria-label="AnyAI ホーム">
    <img src="{{ url_for('static', filename='assets/AnyAI_logo.png') }}" alt="AnyAI ロゴ" style="height:32px; width:auto;">
    <span>AnyAI</span>
  </a>
  <nav class="nav">
    <a href="{{ url_for('main_page') }}" class="{{ 'is-active' if active_page == 'home' else '' }}">Main</a>
    <a href="{{ url_for('video_analysis_page') }}" class="{{ 'is-active' if active_page == 'video-analysis' else '' }}">AnyAIVideoAnalysis</a>
    <a href="{{ url_for('comment_enhancer_page') }}" class="{{ 'is-active' if active_page == 'comment-enhancer' else '' }}">AnyAICommentEnhancer</a>
    <a href="{{ url_for('video_summarizer_page') }}" class="{{ 'is-active' if active_page == 'video-summarizer' else '' }}">AnyAIVideoSummarizer</a>
    <a href="{{ url_for('kol_reviewer_page') }}" class="{{ 'is-active' if active_page == 'kol-reviewer' else '' }}">AnyAIKOLReviewer</a>
  </nav>
</header>

<main class="page container">
  <h1 class="mb-4">AnyAIVideoSummarizer</h1>
  <p class="text-subtle mb-4">`RawData_Video` のE列（動画内容）と `RawData_VideoComment` の同一行コメントを突合し、Geminiで詳細な二行サマリーを生成し `RawData_Video&lt;&gt;Comment` シートへ書き込みます。</p>

  <div class="row" style="gap:var(--anyai-space-05); align-items:flex-start;">
    <div class="card" style="flex:2; min-width:340px;">
      <div class="card-body">
        <form id="review-form" class="column gap-4">
          <div class="field">
            <label for="sheet-url">Google Spreadsheet URL / ID</label>
            <input class="input" type="text" id="sheet-url" placeholder="https://docs.google.com/spreadsheets/d/... または シートID" required>
          </div>
          <div class="grid" style="gap:var(--anyai-space-04); grid-template-columns: repeat(auto-fit, minmax(220px,1fr));">
            <div class="field">
              <label for="start-row">開始行 (デフォルト: 2)</label>
              <input class="input" type="number" id="start-row" value="2" min="2">
            </div>
            <div class="field">
              <label for="end-row">終了行 (任意)</label>
              <input class="input" type="number" id="end-row" placeholder="空欄で最後まで">
            </div>
            <div class="field">
              <label>Gemini モデル</label>
              <label class="radio"><input type="radio" name="model-name" value="gemini-flash-latest" checked><span>Gemini Flash (latest)</span></label>
              <label class="radio"><input type="radio" name="model-name" value="gemini-pro-latest"><span>Gemini Pro (latest)</span></label>
            </div>
            <div class="field">
              <label for="workers">並列処理数</label>
              <input class="input" type="number" id="workers" value="10" min="1" max="50">
            </div>
            <div class="field">
              <label for="output-language">出力言語</label>
              <select class="input" id="output-language">
                <option value="Japanese" selected>日本語</option>
                <option value="English">English</option>
                <option value="Korean">한국어</option>
                <option value="Thai">ภาษาไทย</option>
                <option value="Vietnamese">Tiếng Việt</option>
              </select>
            </div>
            <div class="field">
              <label class="checkbox">
                <input type="checkbox" id="debug-mode">
                <span>デバッグモード（逐次処理＆エラー自動再実行ログ）</span>
              </label>
            </div>
          </div>
          <details>
            <summary>詳細設定 (任意)</summary>
            <div class="grid" style="margin-top:var(--anyai-space-04); gap:var(--anyai-space-04); grid-template-columns: repeat(auto-fit, minmax(180px,1fr));">
              <div class="field">
                <label for="video-sheet-name">動画シート名</label>
                <input class="input" type="text" id="video-sheet-name" value="RawData_Video">
              </div>
              <div class="field">
                <label for="comment-sheet-name">コメントシート名</label>
                <input class="input" type="text" id="comment-sheet-name" value="RawData_VideoComment">
              </div>
              <div class="field">
                <label for="output-sheet-name">出力シート名</label>
                <input class="input" type="text" id="output-sheet-name" value="RawData_Video&lt;&gt;Comment">
              </div>
              <div class="field">
                <label for="video-context-start-col">動画列 (開始)</label>
                <input class="input" type="text" id="video-context-start-col" value="E" maxlength="3">
              </div>
              <div class="field">
                <label for="video-context-end-col">動画列 (終了)</label>
                <input class="input" type="text" id="video-context-end-col" value="E" maxlength="3">
              </div>
              <div class="field">
                <label for="comment-start-col">コメント列 (開始)</label>
                <input class="input" type="text" id="comment-start-col" value="H" maxlength="3">
              </div>
              <div class="field">
                <label for="comment-end-col">コメント列 (終了)</label>
                <input class="input" type="text" id="comment-end-col" value="Q" maxlength="3">
              </div>
              <div class="field">
                <label for="output-col-letter">出力列</label>
                <input class="input" type="text" id="output-col-letter" value="F" maxlength="2">
              </div>
              <div class="field">
                <label for="batch-size">書き込みバッチ</label>
                <input class="input" type="number" id="batch-size" value="30" min="1" max="200">
              </div>
            </div>
          </details>
          <div class="row right">
            <button type="button" class="btn btn-outline" id="stop-button" disabled>停止</button>
            <button type="submit" class="btn btn-primary" id="run-button">実行</button>
          </div>
        </form>
      </div>
    </div>
    <aside class="column gap-4" style="flex:1; min-width:260px;">
      <div class="card">
        <div class="card-header">
          <strong>Spreadsheet History</strong>
        </div>
        <div class="card-body">
          <p class="text-subtle" id="history-empty">実行履歴はまだありません。</p>
          <ul id="history-list" class="column gap-2" style="list-style:none; margin:0; padding:0;"></ul>
        </div>
      </div>
      <div class="card queue-card" id="queue-panel">
        <div class="card-header queue-header">
          <strong>Current Queue</strong>
          <div class="queue-header-actions">
            <button type="button" class="btn btn-text" data-queue-refresh>更新</button>
            <button type="button" class="btn btn-text" data-queue-toggle>折りたたむ</button>
          </div>
        </div>
        <div class="card-body" data-queue-body>
          <div class="queue-content">
            <div class="queue-list-container">
              <ul class="column gap-2" data-queue-list style="list-style:none; margin:0; padding:0; overflow-y:auto; max-height:240px;"></ul>
              <p class="text-subtle" data-queue-empty>待機中のジョブはありません。</p>
            </div>
            <div class="queue-details" data-queue-details hidden>
              <div>
                <strong data-queue-title>(タイトル未取得)</strong><br>
                <a href="#" target="_blank" data-queue-url></a>
              </div>
              <div>機能: <span data-queue-job-type>-</span></div>
              <div>状態: <span data-queue-status class="queue-status queue-status-queued">queued</span></div>
              <div>順番: <span data-queue-order>-</span></div>
              <div class="queue-controls">
                <button type="button" class="btn btn-outline" data-queue-move-up>上へ</button>
                <button type="button" class="btn btn-outline" data-queue-move-down>下へ</button>
                <button type="button" class="btn btn-outline" data-queue-remove>削除</button>
                <button type="button" class="btn btn-outline" data-queue-apply>更新</button>
              </div>
              <textarea data-queue-json rows="6"></textarea>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <section class="mt-6">
    <div class="card">
      <div class="card-header">
        <strong>Execution Log</strong>
      </div>
      <div class="card-body">
        <div id="log-container"><span class="text-subtle">Awaiting configuration...</span></div>
      </div>
    </div>
  </section>
</main>

<script>
  const form = document.getElementById('review-form');
  const logContainer = document.getElementById('log-container');
  const runButton = document.getElementById('run-button');
  const stopButton = document.getElementById('stop-button');
  const historyList = document.getElementById('history-list');
  const historyEmpty = document.getElementById('history-empty');
  const sheetInput = document.getElementById('sheet-url');
  const queuePanel = document.getElementById('queue-panel');
  let currentProcessId = null;
  let eventSource = null;

  const HISTORY_KEY = 'anyai_sheet_history_v3';
  const MAX_HISTORY = 10;

  function log(message, isError = false) {
    const timestamp = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    line.innerHTML = `<span class="text-subtle">[${timestamp}]</span> <span style="color:${isError ? 'var(--anyai-color-danger-700)' : 'inherit'};">${message}</span>`;
    logContainer.appendChild(line);
    logContainer.scrollTop = logContainer.scrollHeight;
  }

  const queueManager = (window.AnyAIQueueManager && queuePanel)
    ? window.AnyAIQueueManager.init({ root: queuePanel, log })
    : null;

  function finalizeUI() {
    runButton.disabled = false;
    runButton.textContent = '実行';
    stopButton.disabled = true;
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
    currentProcessId = null;
  }

  function parseSheetValue(value) {
    return (value || '').trim();
  }

  function loadHistory() {
    try {
      return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    } catch (e) {
      return [];
    }
  }

  function saveHistory(items) {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(items));
  }

  function addToHistory(rawValue, title, status = 'queued') {
    const value = parseSheetValue(rawValue);
    if (!value) return;
    const items = loadHistory().filter(entry => entry.value !== value);
    title = (title || "").trim();
    items.unshift({ value, title, status, savedAt: new Date().toISOString() });
    if (items.length > MAX_HISTORY) items.length = MAX_HISTORY;
    saveHistory(items);
    renderHistory();
  }

  function renderHistory() {
    const items = loadHistory();
    historyList.innerHTML = '';
    if (!items.length) {
      historyEmpty.style.display = 'block';
      return;
    }
    historyEmpty.style.display = 'none';
    for (const entry of items) {
      const value = entry.value;
      const title = entry.title || '';
      const li = document.createElement('li');
      const displayTitle = title || '(シート名未取得)';
      li.innerHTML = `${displayTitle}<br><small class="text-subtle">状態: ${entry.status || 'queued'}</small>`;
      li.title = value;
      li.addEventListener('click', () => {
        sheetInput.value = value;
        sheetInput.focus();
      });
      historyList.appendChild(li);
    }
  }

  renderHistory();

  stopButton.addEventListener('click', async () => {
    if (!currentProcessId) {
      log('-> 停止対象のジョブがありません。', true);
      return;
    }
    stopButton.disabled = true;
    log('-> 停止信号を送信します...');
    try {
      await fetch('/stop-analysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ process_id: currentProcessId }),
      });
      log('-> 停止信号を送信しました。');
    } catch (error) {
      log(`-> 停止リクエストでエラー: ${error}`, true);
    }
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }

    const payload = {
      sheet_url: document.getElementById('sheet-url').value,
      start_row: document.getElementById('start-row').value,
      end_row: document.getElementById('end-row').value,
      model_name: document.querySelector('input[name="model-name"]:checked').value,
      video_sheet_name: document.getElementById('video-sheet-name').value,
      comment_sheet_name: document.getElementById('comment-sheet-name').value,
      output_sheet_name: document.getElementById('output-sheet-name').value,
      video_context_start_col_letter: document.getElementById('video-context-start-col').value,
      video_context_end_col_letter: document.getElementById('video-context-end-col').value,
      comment_start_col_letter: document.getElementById('comment-start-col').value,
      comment_end_col_letter: document.getElementById('comment-end-col').value,
      batch_size: document.getElementById('batch-size').value,
      workers: document.getElementById('workers').value,
      output_language: document.getElementById('output-language').value,
      output_col_letter: document.getElementById('output-col-letter').value,
      debug_mode: document.getElementById('debug-mode').checked,
    };

    logContainer.innerHTML = '';
    log('-> AnyAIVideoSummarizer を開始します...');
    runButton.disabled = true;
    runButton.textContent = '実行中...';
    stopButton.disabled = false;

    try {
      const resp = await fetch('/run-video-comment-review', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const result = await resp.json();
      if (!resp.ok) {
        log(`Error: ${result.error || 'Unknown error'}`, true);
        finalizeUI();
        return;
      }

      currentProcessId = result.process_id;
      const jobSheetUrl = result.sheet_url || payload.sheet_url;
      const jobTitle = result.sheet_title;
      const jobParams = { ...payload };
      addToHistory(jobSheetUrl, jobTitle, 'queued');
      log(`-> Process ID: ${currentProcessId}`);

      if (queueManager) {
        queueManager.addJob({
          process_id: currentProcessId,
          status: result.status || 'queued',
          sheet_title: jobTitle,
          sheet_url: jobSheetUrl,
          params: jobParams,
          job_type: result.job_type,
        });
      }

      eventSource = new EventSource(`/stream-logs?process_id=${currentProcessId}`);
      eventSource.onmessage = (evt) => {
        log(evt.data);
      };
      eventSource.addEventListener('queue', (evt) => {
        try {
          const queuePayload = JSON.parse(evt.data);
          const status = queuePayload.status || 'queued';
          log(`-> ジョブ ${queuePayload.process_id} の状態: ${status}`);
          if (queueManager) {
            queueManager.handleQueueEvent(queuePayload);
          }
          if (queuePayload.process_id === currentProcessId) {
            addToHistory(queuePayload.sheet_url || jobSheetUrl, queuePayload.sheet_title || jobTitle, status);
            renderHistory();
          }
        } catch (error) {
          log(`-> キュー情報の解析に失敗: ${error}`, true);
        }
      });
      eventSource.addEventListener('error', (evt) => {
        if (evt.data) {
          log(`-> ${evt.data}`, true);
        } else {
          log('-> ログストリームが切断されました。', true);
        }
        finalizeUI();
      });
      eventSource.addEventListener('complete', (evt) => {
        log(`-> ${evt.data}`);
        addToHistory(jobSheetUrl, jobTitle, 'completed');
        if (queueManager) {
          queueManager.handleCompletion(currentProcessId);
        }
        renderHistory();
        finalizeUI();
      });
    } catch (error) {
      log(`Network or server error: ${error}`, true);
      finalizeUI();
    }
  });
</script>
</body>
</html>

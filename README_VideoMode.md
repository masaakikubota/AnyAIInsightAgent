# Videoモード要件定義 (Gemini Flash + File API 対応)

## 0. 概要
- CSVベースのスコアリングに加え、動画リンクを入力して動画内容をスコアリングする「Videoモード」を提供する
- 動画は Gemini Flash 系 (gemini-flash-latest) の File API を用いて解析し、System Prompt + 概念スコアリングを同一リクエスト内で完結
- 既存 OAuth を流用して Google Drive から動画を取得

## 1. UI / UX 仕様
- CSVモード / Videoモードを切り替えるラジオボタンもしくはタブを追加
- Videoモード選択時に表示/必須となる項目
  - 発話列は Google Drive 動画リンク列として扱う
  - System Prompt テキストエリアは Videoモード専用文言を初期表示（既存 System Prompt と同じ内容を流用するが、動画を前提とした注意書きを追加できる）
  - 追加オプション: 動画フォーマット（MP4 推奨）や最大サイズに関する注意文言
- 実行設定のデフォルト値（Videoモード専用）
  - 同時実行数 (concurrency): 15
  - タイムアウト秒 (timeout_sec): 300 (5分)
  - その他の設定値は既存CSVと共有（必要に応じて分岐）
- 実行結果表示やログ表示は既存 CSV モードと共通の UI を流用

## 2. バックエンド API & RunConfig
- RunConfig に `mode: Literal["csv", "video"]` を追加
  - モードに応じてデフォルト設定（concurrency / timeoutなど）を切り替え
- `/jobs` エンドポイントで mode を受け取れるよう拡張
- Videoモード時の RunConfig 追加項目
  - `video_download_timeout`（オプション、デフォルト 120 秒程度）
  - `video_temp_dir`（オプション、一時ファイル格納パス）

## 3. ワーカー処理 (Videoモード)
1. 行ごとに動画URL（Google Driveリンク）を取得
2. 既存OAuth認証を利用し、動画をダウンロード
   - 大容量対応のため、ストリーミングDLまたはファイルサイズチェックを実施
   - ダウンロード後は一時ディレクトリに保存
3. Gemini File API へアップロード
   - アップロード結果の `file_id` を取得
   - 同一行で複数カテゴリブロックを処理するときは `file_id` を再利用
4. Gemini Flash に対し、以下を含む1回の`generateContent`リクエストを送信
   - System Prompt（既存仕様）
   - ユーザーパーツ: `file_id` + 概念リスト
   - レスポンス期待値: `[0.0, …, 1.0]` の配列（バッチ数N）
5. 受信したスコアを 0.0〜1.0 で丸めつつシートへ書き込む
6. 使用した一時動画ファイルは安全に削除

## 4. エラー処理
- 動画ダウンロード失敗: 行単位で処理をスキップし、エラー原因をログ化（ログUIに表示）
- Gemini File API へのアップロード失敗: 同上
- Gemini スコアリング失敗 400/429 など: リトライポリシー（既存のバックオフロジック）を踏襲
- タイムアウト: RunConfig.timeout_sec (Videoモードでは 300秒) を越えたら失敗として扱う

## 5. ログ/監査
- 既存の監査ログ/audit を再導入するか検討（VideoモードはファイルIDなど情報量が増えるため、収集方針が必要）
- 最低限、`job_meta`には以下を記録
  - mode (video)
  - 動画ダウンロード時間/アップロード時間
  - file_id（暗号化orマスキング可）

## 6. セキュリティ/コスト留意点
- Google Driveへのアクセス権限・帯域
- Gemini File API 利用課金とリクエスト制限
- 動画ファイルを落とした一時フォルダのアクセス権・クリーンアップ

## 7. 今後の拡張余地
- 動画コンテンツの一部切り出し（サムネイルや要約テキスト）を生成し、スコアリングの補助に利用
- 動画解析結果をメタ情報としてシートへ書き戻す
- 動画内の音声のみを抽出してSTT → テキストをCSVモードで再利用

---

## 実装ステップ（例）
1. モード切替 UI 実装 + RunConfig 拡張
2. 動画ダウンロード+アップロードの共通ユーティリティ作成
3. Videoモード用ワーカーフロー実装（chunk処理＆Geometry analog）
4. Gemini Flash API 呼び出しロジック追加（CSVとの共通化を意識）
5. 動作テスト（短い動画での疎通 → 大容量動画 → エラーケース）
6. ログ/モニタリング整備、ドキュメンテーション

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>AnyAI Cleansing — データクレンジングAIエージェント</title>
    <link rel="icon" href="/static/anyai/assets/AnyAI_Logo_For_Loading.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/anyai/css/main.css" />
    <script src="/static/anyai/loading-overlay.js"></script>
    <script defer src="/static/anyai/vendor/lucide.js"></script>
    <script defer src="/static/anyai/sidebar.js"></script>
    <style>
      input[type="number"],
      input[type="text"],
      input[type="password"],
      input[type="file"],
      textarea {
        width: 100%;
        padding: 6px 10px;
        border-radius: var(--anyai-radius-2);
        border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 30%);
        background: var(--anyai-panel);
        font: inherit;
      }

      textarea {
        min-height: 160px;
        resize: vertical;
      }

      .field-with-action {
        display: flex;
        align-items: stretch;
        gap: 0;
      }

      .field-with-action input[type="text"] {
        flex: 1 1 auto;
        min-width: 0;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-right: 0;
      }

      .field-with-action .input-action-btn {
        flex: 0 0 auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 var(--anyai-space-4, 16px);
        min-width: 72px;
        border-radius: 0 var(--anyai-radius-2, 12px) var(--anyai-radius-2, 12px) 0;
        border-left: 0;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        font-weight: 600;
        transition: transform 0.15s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }

      .field-with-action .input-action-btn:not(.btn-soft-accent) {
        border: none;
        box-shadow: 0 4px 10px rgba(31, 36, 50, 0.12);
      }

      .field-with-action .input-action-btn:not(.btn-soft-accent):hover,
      .field-with-action .input-action-btn:not(.btn-soft-accent):focus-visible {
        box-shadow: 0 6px 16px rgba(31, 36, 50, 0.16);
        outline: none;
      }

      .field-with-action .input-action-btn.btn-soft-accent:hover,
      .field-with-action .input-action-btn.btn-soft-accent:focus-visible {
        transform: translateY(-1px);
      }

      .field-with-action .input-action-btn.btn-soft-accent {
        border-left: 0;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
      }

      .anyai-form-section {
        display: flex;
        flex-direction: column;
        gap: var(--anyai-space-3, 12px);
        background: var(--anyai-form-band, #f1f5f9);
        border-radius: var(--anyai-radius-2, 12px);
        padding: var(--anyai-space-5, 20px) var(--anyai-space-6, 28px);
        border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 85%);
      }

      .anyai-form-group {
        display: flex;
        flex-direction: column;
        gap: var(--anyai-space-3, 12px);
      }

      .field .field-hint {
        margin-top: var(--anyai-space-1, 4px);
      }

      .stack-sm { display: flex; flex-direction: column; gap: var(--anyai-space-3); }
      .muted { color: var(--anyai-text-subtle); font-size: var(--anyai-fs-2); }
      progress { width: 100%; height: 12px; border-radius: var(--anyai-radius-2); overflow: hidden; }
      ul.error-list { margin: 0; padding-left: 18px; }
      ul.error-list li { word-break: break-word; }

      #cleansing-heading {
        margin-bottom: 0;
      }

      .anyai-form-section > header {
        margin-bottom: 0;
      }

      .anyai-form-section > header > h2.mt-0 {
        margin-bottom: 0;
      }

      .cleansing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: var(--anyai-space-3);
        align-items: start;
      }

      .cleansing-grid .field.url-field,
      .cleansing-grid .field.sheet-select-field {
        grid-column: 1 / -1;
      }

      .custom-select {
        position: relative;
        width: 100%;
      }

      .custom-select-native {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        border: 0;
        clip: rect(0 0 0 0);
        clip-path: inset(100%);
        overflow: hidden;
        white-space: nowrap;
      }

      .custom-select-toggle {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--anyai-space-3);
        padding: 6px 40px 6px 12px;
        border-radius: var(--anyai-radius-2);
        border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 20%);
        background: #ffffff;
        color: var(--anyai-text, #1f2432);
        font: inherit;
        line-height: 1.4;
        cursor: pointer;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
        position: relative;
      }

      .custom-select-toggle::after {
        content: "";
        width: 14px;
        height: 14px;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='none' stroke='%23545d72' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.2' d='m3 5 4 4 4-4'/%3E%3C/svg%3E") center / contain no-repeat;
        transition: transform 0.2s ease;
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
      }

      .custom-select-label {
        flex: 1 1 auto;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding-right: var(--anyai-space-2);
      }

      .custom-select:not(.has-value) .custom-select-label {
        color: color-mix(in srgb, var(--anyai-text), transparent 35%);
      }

      .custom-select.is-open .custom-select-toggle {
        border-radius: var(--anyai-radius-2) var(--anyai-radius-2) 0 0;
        border-color: color-mix(in srgb, var(--anyai-border), var(--anyai-primary, #2955ff) 40%);
        box-shadow:
          0 0 0 4px color-mix(in srgb, var(--anyai-primary, #2955ff), transparent 85%),
          0 10px 30px rgba(36, 43, 68, 0.08);
      }

      .custom-select.is-open .custom-select-toggle::after {
        transform: translateY(-50%) rotate(180deg);
      }

      .custom-select.is-disabled .custom-select-toggle {
        cursor: not-allowed;
        background: #f5f7fb;
        color: color-mix(in srgb, var(--anyai-text), transparent 35%);
      }

      .custom-select.is-disabled .custom-select-toggle::after {
        filter: grayscale(1) opacity(0.65);
      }

      .custom-select-menu {
        position: absolute;
        left: 0;
        top: calc(100% - 1px);
        width: 100%;
        background: #ffffff;
        border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 20%);
        border-top: 0;
        border-radius: 0 0 var(--anyai-radius-2) var(--anyai-radius-2);
        box-shadow: 0 22px 40px rgba(36, 43, 68, 0.16);
        max-height: 240px;
        overflow-y: auto;
        padding: 4px 0;
        z-index: 70;
        opacity: 0;
        pointer-events: none;
        transform: translateY(6px);
        transition: opacity 0.18s ease, transform 0.18s ease;
      }

      .custom-select.is-open .custom-select-menu {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }

      .custom-select-option {
        width: 100%;
        padding: 10px 14px;
        background: transparent;
        border: 0;
        font: inherit;
        color: inherit;
        text-align: left;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease;
      }

      .custom-select-option:hover,
      .custom-select-option:focus-visible {
        outline: none;
        background: color-mix(in srgb, var(--anyai-primary), transparent 90%);
      }

      .custom-select-option.is-selected {
        background: color-mix(in srgb, var(--anyai-primary), transparent 85%);
        font-weight: 600;
      }

      .custom-select-option.is-disabled {
        color: color-mix(in srgb, var(--anyai-text), transparent 45%);
        cursor: not-allowed;
      }

      .custom-select-option.is-disabled:hover {
        background: transparent;
      }

      .section-toggle > summary {
        display: flex;
        align-items: center;
        gap: var(--anyai-space-2);
        cursor: pointer;
        list-style: none;
        user-select: none;
      }

      .section-toggle > summary::-webkit-details-marker,
      .section-toggle > summary::marker {
        display: none;
      }

      .section-toggle .caret {
        margin-left: auto;
        align-self: center;
        display: inline-block;
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 8px solid currentColor;
        opacity: 0.8;
        transform: rotate(0deg);
        transform-origin: center;
        transition: transform 0.2s ease;
      }

      .section-toggle[open] .caret {
        transform: rotate(180deg);
      }

      .anyai-form-actions {
        margin-top: var(--anyai-space-8);
        display: flex;
        flex-wrap: wrap;
        gap: var(--anyai-space-3);
        justify-content: center;
        align-items: center;
      }

      .anyai-form-actions .btn {
        min-width: 120px;
      }

      .anyai-action-bar {
        transition: opacity 0.2s ease, transform 0.2s ease;
        left: 50%;
        right: auto;
        bottom: clamp(var(--anyai-space-6, 24px), 6vw, var(--anyai-space-9, 64px));
        transform: translate(-50%, 0);
        justify-content: center;
        padding: var(--anyai-space-2, 8px) var(--anyai-space-3, 12px);
        gap: var(--anyai-space-2, 8px);
      }

      .anyai-action-bar.is-hidden {
        opacity: 0;
        pointer-events: none;
        transform: translate(-50%, 16px);
      }

      .anyai-action-bar.is-empty {
        display: none;
      }

      @media (max-width: 720px) {
        .anyai-form-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .anyai-form-actions .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="anyai-layout">
      <aside class="anyai-sidebar" data-active-tool="cleansing"></aside>
      <main class="anyai-content">
        <div class="anyai-app">
          <section class="anyai-app-primary" aria-labelledby="cleansing-heading">
            <h1 id="cleansing-heading" class="mt-0 page-title-with-icon">
              <span class="page-title-icon" aria-hidden="true"><i data-lucide="wand-2"></i></span>
              <span>Related列を自動クレンジング</span>
            </h1>
            <p class="field-hint">content と Related 列を含むシートを指定すると、重複や欠損を整理した関連語リストを生成します。</p>

            <div class="anyai-form" aria-labelledby="cleansing-config-heading">
              <section class="anyai-form-section" aria-labelledby="input-heading">
                <header>
                  <h2 id="input-heading" class="mt-0">入力設定</h2>
                  <p class="field-hint">処理対象のシート情報とクリーニング条件を入力します。</p>
                </header>
                <form id="cleansing-form">
                  <div class="anyai-form-fields cleansing-grid">
                    <div class="field url-field">
                      <label for="sheet">スプレッドシートURL / ID</label>
                      <p class="field-hint">対象スプレッドシートを指定し、Setボタンでシート一覧を読み込みます。</p>
                      <div class="field-with-action">
                        <input type="text" id="sheet" name="sheet" placeholder="https://docs.google.com/spreadsheets/d/..." required />
                        <button type="button" class="btn btn-primary input-action-btn" id="btn-sheet-set">Set</button>
                      </div>
                    </div>
                    <div class="field sheet-select-field">
                      <label for="sheet_name">対象シート</label>
                      <p class="field-hint">Setで読み込んだシート一覧から選択します。</p>
                      <select id="sheet_name" name="sheet_name" disabled class="js-custom-select" data-placeholder="Setでシートを読み込んでください">
                        <option value="">Setでシートを読み込んでください</option>
                      </select>
                      <details class="field-info">
                        <summary class="info-toggle"><span class="info-toggle-icon" aria-hidden="true">i</span><span>詳細</span></summary>
                        <div class="info-panel">ヘッダーに <code>content</code> と <code>Related</code> が含まれるシートを選択してください。</div>
                      </details>
                    </div>
                    <div class="field">
                      <label for="country">Country</label>
                      <p class="field-hint">クリーニングに利用する地域コード。</p>
                      <input type="text" id="country" name="country" placeholder="例: 日本" required />
                    </div>
                    <div class="field">
                      <label for="product_category">Product Category</label>
                      <p class="field-hint">商材カテゴリを一語で記入します。</p>
                      <input type="text" id="product_category" name="product_category" placeholder="例: ガム" required />
                    </div>
                    <input type="hidden" id="concurrency" name="concurrency" value="50" />
                    <input type="hidden" id="sheet_gid" name="sheet_gid" value="" />
                  </div>
                </form>
              </section>

              <section class="anyai-form-section" aria-labelledby="keys-heading">
                <details id="keys-section" class="section-toggle">
                  <summary>
                    <h2 id="keys-heading" class="mt-0">APIキー設定</h2>
                    <span class="caret" aria-hidden="true"></span>
                  </summary>
                  <form id="keys-form" class="stack">
                    <div class="field">
                      <label for="gemini_api_key">Gemini API Key</label>
                      <input type="password" id="gemini_api_key" name="gemini_api_key" placeholder="GEMINI_API_KEY" />
                    </div>
                    <div class="field">
                      <label for="openai_api_key">OpenAI API Key</label>
                      <input type="password" id="openai_api_key" name="openai_api_key" placeholder="OPENAI_API_KEY" />
                    </div>
                    <div class="field field-inline">
                      <input type="checkbox" id="persist" name="persist" />
                      <label for="persist">.env に保存（ローカル）</label>
                      <button type="submit" class="btn btn-outline right">保存</button>
                    </div>
                  </form>
                </details>
              </section>

              <div class="anyai-form-actions" id="cleansing-action-area">
                <button type="button" class="btn btn-outline" id="btn-refresh-status">再取得</button>
                <button type="submit" class="btn btn-primary" id="btn-cleansing-run" form="cleansing-form">実行</button>
              </div>
            </div>
          </section>

          <aside class="anyai-app-support">
            <section id="job-section" class="anyai-support-card" style="display:none;">
              <div class="stack-sm">
                <div>ジョブID: <code id="job-id"></code></div>
                <div class="muted" id="job-status"></div>
                <progress id="job-progress" value="0" max="100"></progress>
                <div class="muted" id="job-counts"></div>
                <div id="job-message"></div>
                <div id="job-errors" style="display:none;">
                  <h2 class="mt-0" style="margin:0; font-size: var(--anyai-fs-3);">エラー詳細</h2>
                  <ul class="error-list" id="job-error-list"></ul>
                </div>
              </div>
            </section>
          </aside>
        </div>
      </main>
    </div>

    <div class="anyai-action-bar" role="region" aria-label="クレンジング操作">
      <button type="button" class="btn btn-outline" data-proxy-for="btn-refresh-status">再取得</button>
      <button type="button" class="btn btn-primary" data-proxy-for="btn-cleansing-run">実行</button>
    </div>

    <script>
      const loadingOverlay = window.AnyAILoading || {
        run: async (task) => task(),
        wrap: async (promise) => promise,
        show: () => {},
        hide: () => {},
        requireKeys: async () => true,
      };

      const form = document.getElementById('cleansing-form');
      const jobSection = document.getElementById('job-section');
      const jobIdEl = document.getElementById('job-id');
      const jobStatusEl = document.getElementById('job-status');
      const jobCountsEl = document.getElementById('job-counts');
      const jobMessageEl = document.getElementById('job-message');
      const progressEl = document.getElementById('job-progress');
      const errorBox = document.getElementById('job-errors');
      const errorList = document.getElementById('job-error-list');
      const sheetInput = document.getElementById('sheet');
      const sheetSelect = document.getElementById('sheet_name');
      const sheetGidInput = document.getElementById('sheet_gid');
      const setSheetButton = document.getElementById('btn-sheet-set');
      const keysForm = document.getElementById('keys-form');
      const refreshButton = document.getElementById('btn-refresh-status');
      const runButton = document.getElementById('btn-cleansing-run');
      const primaryActionSection = document.getElementById('cleansing-action-area');
      const actionBar = document.querySelector('.anyai-action-bar');
      const actionBarButtons = actionBar ? Array.from(actionBar.querySelectorAll('[data-proxy-for]')) : [];
      const primaryPanel = document.querySelector('.anyai-app-primary');

      const customSelectRegistry = new WeakMap();


      function setupCustomSelect(select) {
        if (!select || customSelectRegistry.has(select)) return;

        const placeholder = select.dataset.placeholder || '';
        const wrapper = document.createElement('div');
        wrapper.className = 'custom-select';

        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.className = 'custom-select-toggle';
        toggle.setAttribute('aria-haspopup', 'listbox');
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('role', 'combobox');

        const label = document.createElement('span');
        label.className = 'custom-select-label';
        label.textContent = placeholder;
        toggle.appendChild(label);

        const menu = document.createElement('div');
        menu.className = 'custom-select-menu';
        menu.setAttribute('role', 'listbox');
        menu.hidden = true;
        menu.tabIndex = -1;

        const menuId = `${select.id || `custom-select-${Math.random().toString(36).slice(2)}`}-menu`;
        menu.id = menuId;
        toggle.setAttribute('aria-controls', menuId);

        const parent = select.parentNode;
        parent.insertBefore(wrapper, select);
        wrapper.appendChild(toggle);
        wrapper.appendChild(menu);
        wrapper.appendChild(select);

        select.classList.add('custom-select-native');
        select.tabIndex = -1;
        select.setAttribute('aria-hidden', 'true');

        const state = {
          select,
          wrapper,
          toggle,
          label,
          menu,
          placeholder,
          isOpen: false,
          focusIndex: -1,
          optionButtons: [],
        };

        function refreshLabel() {
          const selected = Array.from(select.selectedOptions || [])[0];
          const text = selected ? selected.textContent : '';
          label.textContent = text || state.placeholder || '';
          state.wrapper.classList.toggle('has-value', Boolean(selected && selected.value));
        }

        function syncSelectedClass() {
          const value = select.value;
          state.optionButtons.forEach((btn) => {
            const isSelected = btn.dataset.value === value;
            btn.classList.toggle('is-selected', isSelected);
            btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
          });
        }

        function focusOption(index) {
          const enabledOptions = state.optionButtons.filter((btn) => !btn.disabled);
          if (!enabledOptions.length) return;
          const clamped = Math.max(0, Math.min(index, enabledOptions.length - 1));
          const target = enabledOptions[clamped];
          if (!target) return;
          target.focus();
          if (!target.id) {
            const rawIndex = Math.max(0, state.optionButtons.indexOf(target));
            target.id = `${state.menu.id}-option-${rawIndex}`;
          }
          state.toggle.setAttribute('aria-activedescendant', target.id);
          state.focusIndex = clamped;
          const containerRect = state.menu.getBoundingClientRect();
          const targetRect = target.getBoundingClientRect();
          if (targetRect.top < containerRect.top) {
            state.menu.scrollTop -= containerRect.top - targetRect.top + 4;
          } else if (targetRect.bottom > containerRect.bottom) {
            state.menu.scrollTop += targetRect.bottom - containerRect.bottom + 4;
          }
        }

        function focusSelected() {
          const enabledOptions = state.optionButtons.filter((btn) => !btn.disabled);
          const index = enabledOptions.findIndex((btn) => btn.dataset.value === select.value);
          if (index >= 0) {
            focusOption(index);
          } else {
            focusOption(0);
          }
        }

        function closeMenu({ focusToggle = false } = {}) {
          if (!state.isOpen) return;
          state.isOpen = false;
          state.wrapper.classList.remove('is-open');
          state.menu.hidden = true;
          state.toggle.setAttribute('aria-expanded', 'false');
          state.toggle.removeAttribute('aria-activedescendant');
          state.focusIndex = -1;
          document.removeEventListener('pointerdown', handleDocumentPointer, true);
          document.removeEventListener('keydown', handleDocumentKeydown, true);
          if (focusToggle) {
            state.toggle.focus();
          }
        }

        function handleDocumentPointer(event) {
          if (state.wrapper.contains(event.target)) return;
          closeMenu();
        }

        function handleDocumentKeydown(event) {
          if (event.key === 'Escape') {
            event.preventDefault();
            closeMenu({ focusToggle: true });
          }
        }

        function buildMenu() {
          state.menu.innerHTML = '';
          state.menu.scrollTop = 0;
          const options = Array.from(select.options || []);
          state.optionButtons = options.map((option) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'custom-select-option';
            button.textContent = option.textContent;
            button.dataset.value = option.value;
            button.setAttribute('role', 'option');
            button.setAttribute('aria-selected', option.selected ? 'true' : 'false');
            button.tabIndex = -1;
            if (option.disabled) {
              button.disabled = true;
              button.classList.add('is-disabled');
            }
            button.addEventListener('click', () => {
              if (button.disabled) return;
              select.value = option.value;
              select.dispatchEvent(new Event('change', { bubbles: true }));
              closeMenu({ focusToggle: true });
            });
            button.addEventListener('keydown', (event) => {
              if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                button.click();
              } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                focusOption(state.focusIndex + 1);
              } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                focusOption(state.focusIndex - 1);
              } else if (event.key === 'Home') {
                event.preventDefault();
                focusOption(0);
              } else if (event.key === 'End') {
                event.preventDefault();
                const enabled = state.optionButtons.filter((btn) => !btn.disabled);
                focusOption(enabled.length - 1);
              } else if (event.key === 'Escape') {
                event.preventDefault();
                closeMenu({ focusToggle: true });
              }
            });
            state.menu.appendChild(button);
            return button;
          });
          syncSelectedClass();
        }

        function openMenu() {
          if (state.isOpen || select.disabled) return;
          buildMenu();
          state.isOpen = true;
          state.wrapper.classList.add('is-open');
          state.menu.hidden = false;
          state.toggle.setAttribute('aria-expanded', 'true');
          document.addEventListener('pointerdown', handleDocumentPointer, true);
          document.addEventListener('keydown', handleDocumentKeydown, true);
          requestAnimationFrame(() => {
            focusSelected();
          });
        }

        function syncDisabled() {
          const disabled = select.disabled;
          state.toggle.disabled = disabled;
          state.toggle.setAttribute('aria-disabled', disabled ? 'true' : 'false');
          state.wrapper.classList.toggle('is-disabled', disabled);
          if (disabled) {
            closeMenu();
          }
        }

        toggle.addEventListener('click', () => {
          if (state.isOpen) {
            closeMenu();
          } else {
            openMenu();
          }
        });

        toggle.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
            event.preventDefault();
            openMenu();
          }
        });

        menu.addEventListener('focusout', (event) => {
          if (!state.wrapper.contains(event.relatedTarget)) {
            closeMenu();
          }
        });

        select.addEventListener('change', () => {
          refreshLabel();
          syncSelectedClass();
        });

        const optionObserver = new MutationObserver(() => {
          buildMenu();
          refreshLabel();
        });
        optionObserver.observe(select, { childList: true });

        const attributeObserver = new MutationObserver(() => {
          syncDisabled();
        });
        attributeObserver.observe(select, { attributes: true, attributeFilter: ['disabled'] });

        customSelectRegistry.set(select, {
          state,
          refreshLabel,
          syncDisabled,
          syncSelectedClass,
          setPlaceholder(placeholderText) {
            state.placeholder = placeholderText || '';
            if (!select.value) {
              state.label.textContent = state.placeholder;
              state.wrapper.classList.toggle('has-value', false);
            }
          },
        });

        refreshLabel();
        syncDisabled();
        buildMenu();
      }

      function updateCustomSelectPlaceholder(select, placeholderText) {
        const entry = customSelectRegistry.get(select);
        if (!entry) return;
        entry.state.placeholder = placeholderText || '';
        if (!select.value) {
          entry.state.label.textContent = entry.state.placeholder;
          entry.state.wrapper.classList.toggle('has-value', false);
        }
        entry.syncSelectedClass();
      }

      function syncCustomSelectDisabled(select) {
        const entry = customSelectRegistry.get(select);
        if (!entry) return;
        entry.syncDisabled();
      }

      function refreshCustomSelect(select) {
        const entry = customSelectRegistry.get(select);
        if (!entry) return;
        entry.refreshLabel();
        entry.syncSelectedClass();
      }

      let resolvedSpreadsheetId = '';
      let resolvedSheets = [];

      let currentJobId = null;
      let pollTimer = null;

      function stopPolling() {
        if (pollTimer) {
          clearTimeout(pollTimer);
          pollTimer = null;
        }
      }

      function positionActionBar() {
        if (!actionBar || !primaryPanel) return;
        const hasVisibleProxy = actionBarButtons.some((proxy) => proxy.style.display !== 'none');
        if (!hasVisibleProxy) return;
        const panelRect = primaryPanel.getBoundingClientRect();
        if (panelRect.width <= 0) return;
        actionBar.style.removeProperty('width');
        const naturalWidth = actionBar.offsetWidth;
        const maxWidth = Math.max(panelRect.width - 24, 0);
        const finalWidth = maxWidth > 0 ? Math.min(naturalWidth, maxWidth) : naturalWidth;
        actionBar.style.width = `${finalWidth}px`;
        actionBar.style.left = `${panelRect.left + panelRect.width / 2}px`;
      }

      function syncActionProxies() {
        if (!actionBarButtons.length) return;
        actionBarButtons.forEach((proxy) => {
          const targetId = proxy.dataset.proxyFor;
          const target = targetId ? document.getElementById(targetId) : null;
          if (!target) {
            proxy.disabled = true;
            proxy.style.display = 'none';
            return;
          }
          const targetStyle = window.getComputedStyle(target);
          const hidden =
            targetStyle.display === 'none' ||
            targetStyle.visibility === 'hidden' ||
            target.hasAttribute('hidden');
          proxy.style.display = hidden ? 'none' : '';
          proxy.disabled = target.disabled;
          proxy.textContent = target.textContent;
          if (target.hasAttribute('aria-busy')) {
            proxy.setAttribute('aria-busy', target.getAttribute('aria-busy') || 'false');
          } else {
            proxy.removeAttribute('aria-busy');
          }
        });
        if (actionBar) {
          const anyVisible = actionBarButtons.some((proxy) => proxy.style.display !== 'none');
          actionBar.classList.toggle('is-empty', !anyVisible);
          positionActionBar();
        }
      }

      function setButtonBusy(button, busyLabel) {
        if (!button) return () => {};
        const originalWidth = button.offsetWidth || button.getBoundingClientRect().width;
        const original = {
          text: button.textContent,
          width: originalWidth,
          minWidth: button.style.minWidth,
          disabled: button.disabled,
        };
        button.setAttribute('aria-busy', 'true');
        button.disabled = true;
        if (busyLabel) {
          button.textContent = busyLabel;
        }
        if (original.width) {
          const busyWidth = Math.max(original.width, button.offsetWidth || button.getBoundingClientRect().width);
          button.style.minWidth = `${busyWidth}px`;
        }
        syncActionProxies();
        return () => {
          button.removeAttribute('aria-busy');
          button.style.removeProperty('min-width');
          if (busyLabel) {
            button.textContent = original.text;
          }
          button.disabled = original.disabled;
          if (original.minWidth) {
            button.style.minWidth = original.minWidth;
          }
          syncActionProxies();
        };
      }

      async function fetchStatus(jobId) {
        const res = await fetch(`/cleansing/jobs/${jobId}`);
        if (!res.ok) throw new Error('ステータス取得に失敗しました');
        return res.json();
      }

      function renderStatus(state) {
        jobSection.style.display = 'block';
        jobIdEl.textContent = state.job_id;
        jobStatusEl.textContent = `ステータス: ${state.status}`;
        jobMessageEl.textContent = state.message || '';
        const total = state.total_items || 0;
        const processed = state.processed_items || 0;
        const success = state.success_count || 0;
        const fallback = state.fallback_count || 0;
        const failure = state.failure_count || 0;
        progressEl.value = total ? Math.floor((processed / total) * 100) : 0;
        jobCountsEl.textContent = `対象 ${total} 件 / 処理済み ${processed} 件 (成功 ${success}, フォールバック ${fallback}, 失敗 ${failure})`;

        const errors = state.errors || [];
        if (errors.length) {
          errorBox.style.display = 'block';
          errorList.innerHTML = '';
          errors.slice(0, 20).forEach((err) => {
            const li = document.createElement('li');
            li.textContent = `row ${err.row_number}: ${err.reason}`;
            errorList.appendChild(li);
          });
          if (errors.length > 20) {
            const li = document.createElement('li');
            li.textContent = `… 残り ${errors.length - 20} 件`; 
            errorList.appendChild(li);
          }
        } else {
          errorBox.style.display = 'none';
          errorList.innerHTML = '';
        }

        const stillRunning = state.status === 'pending' || state.status === 'running';
        if (stillRunning) {
          pollTimer = setTimeout(() => pollStatus(currentJobId), 2000);
        } else {
          stopPolling();
        }
      }

      async function pollStatus(jobId) {
        try {
          const state = await fetchStatus(jobId);
          renderStatus(state);
        } catch (err) {
          console.error(err);
          jobStatusEl.textContent = 'ステータス取得に失敗しました';
          stopPolling();
        }
      }

      if (actionBar && actionBarButtons.length) {
        actionBarButtons.forEach((proxy) => {
          const targetId = proxy.dataset.proxyFor;
          proxy.addEventListener('click', (event) => {
            if (!targetId) return;
            const target = document.getElementById(targetId);
            if (!target || target.disabled) {
              event.preventDefault();
              return;
            }
            target.click();
          });
        });
      }

      if (primaryActionSection && actionBar) {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              positionActionBar();
              if (entry.isIntersecting) {
                actionBar.classList.add('is-hidden');
              } else {
                actionBar.classList.remove('is-hidden');
              }
            });
          },
          { threshold: 0.2 },
        );
        observer.observe(primaryActionSection);
      }

      if (actionBar) {
        syncActionProxies();
        window.addEventListener('resize', positionActionBar);
        window.addEventListener('orientationchange', positionActionBar);
        if (primaryPanel && 'ResizeObserver' in window) {
          const actionBarResizeObserver = new ResizeObserver(() => positionActionBar());
          actionBarResizeObserver.observe(primaryPanel);
        }
      }

      refreshButton?.addEventListener('click', () => {
        if (currentJobId) {
          pollStatus(currentJobId);
        } else {
          alert('現在アクティブなジョブはありません');
        }
      });

      function clearSheetSelection(message = 'Setでシートを読み込んでください') {
        if (!sheetSelect) return;
        sheetSelect.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = message;
        sheetSelect.appendChild(opt);
        sheetSelect.value = '';
        sheetSelect.disabled = true;
        sheetSelect.dataset.placeholder = message;
        updateCustomSelectPlaceholder(sheetSelect, message);
        syncCustomSelectDisabled(sheetSelect);
        refreshCustomSelect(sheetSelect);
        if (sheetGidInput) sheetGidInput.value = '';
      }

      setupCustomSelect(sheetSelect);
      clearSheetSelection();

      function updateSheetGid() {
        if (!sheetSelect || !sheetGidInput) return;
        const option = sheetSelect.selectedOptions && sheetSelect.selectedOptions[0];
        sheetGidInput.value = option && option.dataset.sheetId ? option.dataset.sheetId : '';
      }

      async function handleSheetSet() {
        if (!sheetInput || !sheetInput.value.trim()) {
          alert('スプレッドシートURL/IDを入力してください');
          return;
        }
        if (!setSheetButton) return;
        const releaseBusy = setButtonBusy(setSheetButton, '取得中...');
        resolvedSpreadsheetId = '';
        resolvedSheets = [];
        clearSheetSelection('シート一覧を取得中...');
        try {
          const res = await fetch('/cleansing/sheets/list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sheet: sheetInput.value.trim() }),
          });
          let data = null;
          try {
            data = await res.json();
          } catch (_) {}
          if (!res.ok || !data || !data.ok) {
            const message = (data && data.message) || 'シート一覧の取得に失敗しました';
            alert(message);
            clearSheetSelection('再度 Set を実行してください');
            return;
          }
          resolvedSpreadsheetId = data.spreadsheet_id || sheetInput.value.trim();
          resolvedSheets = Array.isArray(data.sheets) ? data.sheets : [];
          sheetSelect.innerHTML = '';
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = '対象シートを選択してください';
          sheetSelect.appendChild(placeholder);
          resolvedSheets.forEach((item) => {
            const option = document.createElement('option');
            option.value = item.sheet_name;
            option.textContent = item.sheet_name;
            option.dataset.sheetId = String(item.sheet_id);
            sheetSelect.appendChild(option);
          });
          sheetSelect.disabled = resolvedSheets.length === 0;
          sheetSelect.dataset.placeholder = placeholder.textContent;
          updateCustomSelectPlaceholder(sheetSelect, placeholder.textContent);
          syncCustomSelectDisabled(sheetSelect);
          refreshCustomSelect(sheetSelect);
          if (!sheetSelect.disabled) {
            const entry = customSelectRegistry.get(sheetSelect);
            entry?.state.toggle.focus();
          }
        } catch (err) {
          console.error(err);
          alert('シート一覧の取得に失敗しました');
          clearSheetSelection('再度 Set を実行してください');
        } finally {
          releaseBusy();
        }
      }

      if (setSheetButton) {
        setSheetButton.addEventListener('click', () => {
          void handleSheetSet();
        });
      }

      if (sheetSelect) {
        sheetSelect.addEventListener('change', () => {
          updateSheetGid();
          refreshCustomSelect(sheetSelect);
        });
      }

      if (keysForm) {
        keysForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(keysForm);
          fd.set('persist', document.getElementById('persist')?.checked ? 'true' : 'false');
          const res = await fetch('/settings', { method: 'POST', body: fd });
          if (!res.ok) {
            alert('APIキーの保存に失敗しました');
            return;
          }
          alert('APIキーを保存しました');
        });
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!sheetInput?.value.trim()) {
          alert('スプレッドシートURL/IDを入力してください');
          return;
        }
        if (!sheetSelect || sheetSelect.disabled || !sheetSelect.value) {
          alert('対象シートを選択してください');
          return;
        }
        const releaseRunButton = setButtonBusy(runButton, '実行中...');
        stopPolling();
        try {
          await loadingOverlay.run(async () => {
            const fd = new FormData(form);
            if (!fd.get('concurrency')) {
              fd.set('concurrency', '50');
            }
            fd.set('sheet_name', sheetSelect.value);
            if (sheetGidInput && sheetGidInput.value) {
              fd.set('sheet_gid', sheetGidInput.value);
            } else {
              fd.delete('sheet_gid');
            }
            const res = await fetch('/cleansing/jobs', { method: 'POST', body: fd });
            if (!res.ok) {
              let message = 'ジョブの作成に失敗しました';
              try {
                const detail = await res.json();
                if (detail?.detail) {
                  message = detail.detail;
                }
              } catch (_) {
                try {
                  const text = await res.text();
                  if (text) message = text;
                } catch (__) {}
              }
              alert(message);
              return;
            }
            const data = await res.json();
            currentJobId = data.job_id;
            jobSection.style.display = 'block';
            progressEl.value = 0;
            jobStatusEl.textContent = 'ステータス: pending';
            jobMessageEl.textContent = 'ジョブを開始しました。';
            jobCountsEl.textContent = '';
            errorList.innerHTML = '';
            errorBox.style.display = 'none';
            pollStatus(currentJobId);
          });
        } finally {
          releaseRunButton();
        }
      });
    </script>
  </body>
</html>

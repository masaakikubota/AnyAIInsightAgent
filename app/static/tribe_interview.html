<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>AnyAI Tribe Interview</title>
    <link rel="icon" href="/static/anyai/assets/AnyAI_Logo_For_Loading.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/anyai/css/main.css" />
    <script src="/static/anyai/loading-overlay.js"></script>
    <script defer src="/static/anyai/vendor/lucide.js"></script>
    <script defer src="/static/anyai/sidebar.js"></script>
    <style>
      :root { color-scheme: light dark; }
      body {
        font-family: 'Noto Sans JP', sans-serif;
        background: var(--anyai-bg);
        color: var(--anyai-text);
        min-height: 100vh;
        margin: 0;
      }

      .anyai-form-fields.is-two-column {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      .anyai-form-fields.is-three-column {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .mode-radio-group {
        display: flex;
        gap: var(--anyai-space-3);
        flex-wrap: nowrap;
      }
      .mode-radio-group label {
        display: inline-flex;
        align-items: center;
        gap: var(--anyai-space-2);
        font-weight: 600;
      }
      .muted {
        color: var(--anyai-text-subtle);
        font-size: var(--anyai-fs-2);
      }
      textarea { min-height: 120px; resize: vertical; }
      .custom-select {
        position: relative;
        width: 100%;
      }

      .custom-select-native {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        border: 0;
        clip: rect(0 0 0 0);
        clip-path: inset(100%);
        overflow: hidden;
        white-space: nowrap;
      }

      .custom-select-toggle {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--anyai-space-3);
        padding: 6px 40px 6px 12px;
        border-radius: var(--anyai-radius-2);
        border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 20%);
        background: #ffffff;
        color: var(--anyai-text, #1f2432);
        font: inherit;
        line-height: 1.4;
        cursor: pointer;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
        position: relative;
      }

      .custom-select-toggle::after {
        content: "";
        width: 14px;
        height: 14px;
        flex: 0 0 auto;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='none' stroke='%23545d72' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.2' d='m3 5 4 4 4-4'/%3E%3C/svg%3E") center / contain no-repeat;
        transition: transform 0.2s ease;
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
      }

      .custom-select-label {
        flex: 1 1 auto;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding-right: var(--anyai-space-2);
      }

      .custom-select.is-open .custom-select-toggle {
        border-radius: var(--anyai-radius-2) var(--anyai-radius-2) 0 0;
        border-color: color-mix(in srgb, var(--anyai-border), var(--anyai-primary, #2955ff) 40%);
        box-shadow:
          0 0 0 4px color-mix(in srgb, var(--anyai-primary, #2955ff), transparent 85%),
          0 10px 30px rgba(36, 43, 68, 0.08);
      }

      .custom-select.is-open .custom-select-toggle::after {
        transform: rotate(180deg);
      }

      .custom-select:not(.has-value) .custom-select-label {
        color: color-mix(in srgb, var(--anyai-text), transparent 35%);
      }

      .custom-select.is-disabled .custom-select-toggle {
        cursor: not-allowed;
        background: #f5f7fb;
        color: color-mix(in srgb, var(--anyai-text), transparent 35%);
      }

      .custom-select.is-disabled .custom-select-toggle::after {
        filter: grayscale(1) opacity(0.65);
      }

      .custom-select-menu {
        position: absolute;
        left: 0;
        top: calc(100% - 1px);
        width: 100%;
        background: #ffffff;
        border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 20%);
        border-top: 0;
        border-radius: 0 0 var(--anyai-radius-2) var(--anyai-radius-2);
        box-shadow: 0 22px 40px rgba(36, 43, 68, 0.16);
        max-height: 280px;
        overflow-y: auto;
        padding: 4px 0;
        z-index: 70;
        opacity: 0;
        pointer-events: none;
        transform: translateY(6px);
        transition: opacity 0.18s ease, transform 0.18s ease;
      }

      .custom-select.is-open .custom-select-menu {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }

      .custom-select-option {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 10px 14px;
        background: transparent;
        border: 0;
        font: inherit;
        color: inherit;
        text-align: left;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease;
      }

      .custom-select-option:hover,
      .custom-select-option:focus-visible {
        outline: none;
        background: color-mix(in srgb, var(--anyai-primary), transparent 90%);
      }

      .custom-select-option.is-selected {
        background: color-mix(in srgb, var(--anyai-primary), transparent 85%);
        font-weight: 600;
      }

      .custom-select-option.is-disabled {
        color: color-mix(in srgb, var(--anyai-text), transparent 45%);
        cursor: not-allowed;
      }

      .custom-select-option.is-disabled:hover {
        background: transparent;
      }

      .field-with-action {
        display: flex;
        align-items: stretch;
        gap: 0;
        flex-wrap: nowrap;
      }
      .field-with-action input[type="text"],
      .field-with-action input[type="url"] {
        flex: 1 1 auto;
        min-width: 0;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-right: 0;
      }
      .field-with-action .input-action-btn {
        flex: 0 0 auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 var(--anyai-space-4, 16px);
        min-width: 72px;
        border-radius: 0 var(--anyai-radius-2, 12px) var(--anyai-radius-2, 12px) 0;
        border-left: 0;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        font-weight: 600;
        transition: transform 0.15s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }
      .field-with-action .input-action-btn:not(.btn-soft-accent) {
        border: none;
        box-shadow: 0 4px 10px rgba(31, 36, 50, 0.12);
      }
      .field-with-action .input-action-btn:not(.btn-soft-accent):hover,
      .field-with-action .input-action-btn:not(.btn-soft-accent):focus-visible {
        box-shadow: 0 6px 16px rgba(31, 36, 50, 0.16);
        outline: none;
      }
      .field-with-action .input-action-btn.btn-soft-accent:hover,
      .field-with-action .input-action-btn.btn-soft-accent:focus-visible {
        transform: translateY(-1px);
      }
      .field-with-action .input-action-btn.btn-soft-accent {
        border-left: 0;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
      }
      .dropzone {
        border: 1px dashed color-mix(in srgb, var(--anyai-border), var(--anyai-text) 12%);
        border-radius: var(--anyai-radius-2, 12px);
        padding: var(--anyai-space-3);
        text-align: center;
        background: var(--anyai-panel, #ffffff);
        cursor: pointer;
        transition: border-color 0.2s ease, background 0.2s ease;
      }
      .dropzone.dragover {
        border-color: var(--anyai-primary);
        background: color-mix(in srgb, var(--anyai-primary), transparent 88%);
      }
      .image-preview-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: var(--anyai-space-3);
        margin-top: var(--anyai-space-3);
      }
      .image-card {
        background: var(--anyai-panel, #ffffff);
        border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 40%);
        border-radius: 14px;
        padding: var(--anyai-space-2);
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
      }
      .image-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        background: #111;
      }
      .remove-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 50%;
        background: rgba(20, 24, 36, 0.78);
        color: #fff;
        cursor: pointer;
      }
      .anyai-form-actions {
        margin-top: var(--anyai-space-6);
        display: flex;
        justify-content: flex-end;
        gap: var(--anyai-space-3);
        flex-wrap: wrap;
      }
      .anyai-form-actions .btn {
        min-width: 180px;
      }
      .metrics-list,
      .artifact-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: var(--anyai-fs-2);
      }
      @media (max-width: 720px) {
        .anyai-form-actions {
          justify-content: center;
        }
        .anyai-form-actions .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="anyai-layout">
      <aside class="anyai-sidebar" data-active-tool="tribe-interview"></aside>
      <main class="anyai-content">
        <div class="anyai-app">
          <section class="anyai-app-primary" aria-labelledby="tribe-heading">
            <h1 id="tribe-heading" class="mt-0">Tribe Interview パイプライン</h1>
            <p class="field-hint">トライブ生成からインタビュー回答・Embedding まで一括で実行します。</p>

            <form id="tribe-form" class="anyai-form" enctype="multipart/form-data">
              <section class="anyai-form-section" aria-labelledby="basic-heading">
                <header>
                  <h2 id="basic-heading" class="mt-0">基本情報</h2>
                  <p class="field-hint">カテゴリと地域に基づいてトライブを生成します。</p>
                </header>
                <div class="anyai-form-fields is-two-column">
                  <div class="field">
                    <label for="product_category">Product Category</label>
                    <input type="text" class="input" id="product_category" name="product_category" placeholder="例: ヘアケア" required />
                  </div>
                  <div class="field">
                    <label for="country_region">Country / Region</label>
                    <input type="text" class="input" id="country_region" name="country_region" placeholder="例: JP_Kanto" required />
                  </div>
                </div>
                <div class="field">
                  <span class="sr-only" id="mode-label">モード選択</span>
                  <div class="mode-radio-group" role="radiogroup" aria-labelledby="mode-label">
                    <label><input type="radio" name="mode" value="product" checked /> 製品モード</label>
                    <label><input type="radio" name="mode" value="communication" /> コミュニケーションモード</label>
                  </div>
                  <p class="field-hint">製品モードは商品評価、コミュニケーションモードはタグライン評価にフォーカスします。</p>
                </div>
                <div class="field" id="product-detail-field">
                  <label for="product_detail">製品詳細・特徴（任意）</label>
                  <textarea id="product_detail" name="product_detail" placeholder="例: 低刺激の頭皮ケア用美容液。主要成分..."></textarea>
                </div>
                <div class="field" id="tagline-detail-field" style="display:none;">
                  <label for="tagline_detail">タグライン / コピー（任意）</label>
                  <textarea id="tagline_detail" name="tagline_detail" placeholder="例: 'Reset your scalp, reset your day.'"></textarea>
                </div>
              </section>

              <section class="anyai-form-section" aria-labelledby="generation-heading">
                <header>
                  <h2 id="generation-heading" class="mt-0">生成パラメータ</h2>
                  <p class="field-hint">ペルソナ／インタビュー生成数や補助テンプレートを設定します。</p>
                </header>
                <div class="anyai-form-fields is-two-column">
                  <div class="field">
                    <label for="persona_per_combination">ペルソナ数（各トライブ組合せ）</label>
                    <input type="number" class="input" id="persona_per_combination" name="persona_per_combination" value="3" min="1" max="10" required />
                  </div>
                  <div class="field">
                    <label for="interviews_per_persona">インタビュー数（各ペルソナ）</label>
                    <input type="number" class="input" id="interviews_per_persona" name="interviews_per_persona" value="3" min="1" max="10" required />
                  </div>
                </div>
                <div class="field">
                  <label for="persona_prompt_template">ペルソナプロンプトテンプレ（任意）</label>
                  <textarea id="persona_prompt_template" name="persona_prompt_template" placeholder="ペルソナに含めたい追加条件があれば記載してください。"></textarea>
                </div>
                <div class="field">
                  <label for="interview_questions">カスタム質問（任意）</label>
                  <textarea id="interview_questions" name="interview_questions" placeholder="1行につき1質問を入力。空欄の場合はデフォルト質問を使用します。"></textarea>
                </div>
              </section>

              <section class="anyai-form-section" aria-labelledby="sheet-heading">
                <header>
                  <h2 id="sheet-heading" class="mt-0">Google Sheets 設定</h2>
                  <p class="field-hint">処理対象となるスプレッドシートと各出力タブを選択します。</p>
                </header>
                <div class="field">
                  <label for="spreadsheet_url">スプレッドシート URL / ID</label>
                  <div class="field-with-action">
                    <input type="text" class="input" id="spreadsheet_url" name="spreadsheet_url" placeholder="https://docs.google.com/spreadsheets/d/..." required />
                    <button type="button" class="btn btn-primary input-action-btn" id="btn-spreadsheet-set">Set</button>
                  </div>
                  <p class="field-hint" id="sheet-status">Set を押してシート一覧を読み込みます。</p>
                </div>
                <div class="anyai-form-fields is-three-column">
                  <div class="field">
                    <label for="tribe_sheet">Tribe_SetUp</label>
                    <select id="tribe_sheet" name="tribe_sheet_name" data-default="Tribe_SetUp" class="js-custom-select" data-placeholder="シートを選択">
                      <option value="Tribe_SetUp" selected>Tribe_SetUp</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="combination_sheet">Tribe_Combination</label>
                    <select id="combination_sheet" name="combination_sheet_name" data-default="Tribe_Combination" class="js-custom-select" data-placeholder="シートを選択">
                      <option value="Tribe_Combination" selected>Tribe_Combination</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="persona_sheet">Persona_SetUp</label>
                    <select id="persona_sheet" name="persona_sheet_name" data-default="Persona_SetUp" class="js-custom-select" data-placeholder="シートを選択">
                      <option value="Persona_SetUp" selected>Persona_SetUp</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="qa_llm_sheet">QA_LLM</label>
                    <select id="qa_llm_sheet" name="qa_llm_sheet_name" data-default="QA_LLM" class="js-custom-select" data-placeholder="シートを選択">
                      <option value="QA_LLM" selected>QA_LLM</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="qa_embedding_sheet">QA_Embedding</label>
                    <select id="qa_embedding_sheet" name="qa_embedding_sheet_name" data-default="QA_Embedding" class="js-custom-select" data-placeholder="シートを選択">
                      <option value="QA_Embedding" selected>QA_Embedding</option>
                    </select>
                  </div>
                </div>
              </section>

              <section class="anyai-form-section" aria-labelledby="asset-heading">
                <header>
                  <h2 id="asset-heading" class="mt-0">補助アセット（任意）</h2>
                  <p class="field-hint">商品ビジュアルや資料があればアップロードしてください。</p>
                </header>
                <div class="field">
                  <div id="image-dropzone" class="dropzone" tabindex="0">
                    <strong>画像をドロップ / ペースト / クリックして選択</strong>
                    <p class="muted" style="margin:4px 0 0;">PNG・JPEG など複数可。最大5MB/枚。</p>
                  </div>
                  <input type="file" id="manual_images" name="manual_images" accept="image/*" hidden multiple />
                  <div id="image-preview" class="image-preview-list"></div>
                </div>
              </section>

              <div class="anyai-form-actions">
                <button type="submit" class="btn btn-primary">パイプラインを開始</button>
              </div>
            </form>

            <section id="job-section" class="anyai-form-section" style="display:none;" aria-live="polite">
              <header>
                <h2 class="mt-0">ジョブステータス</h2>
                <p class="field-hint">数秒ごとに進捗を更新します。</p>
              </header>
              <div class="field">ジョブID: <code id="job-id"></code></div>
              <div class="field"><span class="muted" id="job-stage"></span></div>
              <div class="field"><span class="muted" id="job-message"></span></div>
              <div class="field">
                <label>メトリクス</label>
                <div id="job-metrics" class="metrics-list muted"></div>
              </div>
              <div class="field">
                <label>成果物</label>
                <div id="job-artifacts" class="artifact-list muted"></div>
              </div>
            </section>
          </section>
        </div>
      </main>
    </div>

    <script>
      (function () {
        const loadingOverlay = window.AnyAILoading || {
          run: async (task) => task(),
          wrap: async (promise) => promise,
          show: () => {},
          hide: () => {},
          requireKeys: async () => true,
        };

        const form = document.getElementById('tribe-form');
        const spreadsheetUrlInput = document.getElementById('spreadsheet_url');
        const setButton = document.getElementById('btn-spreadsheet-set');
        const sheetStatus = document.getElementById('sheet-status');
        const sheetSelects = {
          tribe: document.getElementById('tribe_sheet'),
          combination: document.getElementById('combination_sheet'),
          persona: document.getElementById('persona_sheet'),
          qaLLM: document.getElementById('qa_llm_sheet'),
          qaEmbedding: document.getElementById('qa_embedding_sheet'),
        };

        const customSelectRegistry = new WeakMap();

        function setupCustomSelect(select) {
          if (!select || customSelectRegistry.has(select)) return;

          const placeholder = select.dataset.placeholder || '';
          const wrapper = document.createElement('div');
          wrapper.className = 'custom-select';

          const toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'custom-select-toggle';
          toggle.setAttribute('aria-haspopup', 'listbox');
          toggle.setAttribute('aria-expanded', 'false');

          const label = document.createElement('span');
          label.className = 'custom-select-label';
          label.textContent = placeholder;
          toggle.appendChild(label);

          const menu = document.createElement('div');
          menu.className = 'custom-select-menu';
          menu.setAttribute('role', 'listbox');
          menu.hidden = true;
          menu.tabIndex = -1;

          const menuId = `${select.id || `custom-select-${Math.random().toString(36).slice(2)}`}-menu`;
          menu.id = menuId;
          toggle.setAttribute('aria-controls', menuId);
          toggle.setAttribute('role', 'combobox');

          const parent = select.parentNode;
          parent.insertBefore(wrapper, select);
          wrapper.appendChild(toggle);
          wrapper.appendChild(menu);
          wrapper.appendChild(select);

          select.classList.add('custom-select-native');
          select.tabIndex = -1;
          select.setAttribute('aria-hidden', 'true');

          const state = {
            select,
            wrapper,
            toggle,
            label,
            menu,
            placeholder,
            isOpen: false,
            focusIndex: -1,
            optionButtons: [],
            observers: [],
          };

          function refreshLabel() {
            const selected = Array.from(select.selectedOptions || [])[0];
            const text = selected ? selected.textContent : '';
            label.textContent = text || state.placeholder || '';
            state.wrapper.classList.toggle('has-value', Boolean(selected && selected.value));
          }

          function syncSelectedClass() {
            const value = select.value;
            state.optionButtons.forEach((btn) => {
              const isSelected = btn.dataset.value === value;
              btn.classList.toggle('is-selected', isSelected);
              btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
            });
          }

          function focusOption(index) {
            const enabledOptions = state.optionButtons.filter((btn) => !btn.disabled);
            if (!enabledOptions.length) return;
            const clamped = Math.max(0, Math.min(index, enabledOptions.length - 1));
            const target = enabledOptions[clamped];
            if (!target) return;
            target.focus();
            if (!target.id) {
              const rawIndex = Math.max(0, state.optionButtons.indexOf(target));
              target.id = `${state.menu.id}-option-${rawIndex}`;
            }
            state.toggle.setAttribute('aria-activedescendant', target.id);
            state.focusIndex = clamped;
            const containerRect = state.menu.getBoundingClientRect();
            const targetRect = target.getBoundingClientRect();
            if (targetRect.top < containerRect.top) {
              state.menu.scrollTop -= containerRect.top - targetRect.top + 4;
            } else if (targetRect.bottom > containerRect.bottom) {
              state.menu.scrollTop += targetRect.bottom - containerRect.bottom + 4;
            }
          }

          function focusSelected() {
            const enabledOptions = state.optionButtons.filter((btn) => !btn.disabled);
            const index = enabledOptions.findIndex((btn) => btn.dataset.value === select.value);
            if (index >= 0) {
              focusOption(index);
            } else {
              focusOption(0);
            }
          }

          function closeMenu({ focusToggle = false } = {}) {
            if (!state.isOpen) return;
            state.isOpen = false;
            state.wrapper.classList.remove('is-open');
            state.menu.hidden = true;
            state.toggle.setAttribute('aria-expanded', 'false');
            state.toggle.removeAttribute('aria-activedescendant');
            state.focusIndex = -1;
            document.removeEventListener('pointerdown', handleDocumentPointer, true);
            document.removeEventListener('keydown', handleDocumentKeydown, true);
            if (focusToggle) {
              state.toggle.focus();
            }
          }

          function openMenu() {
            if (state.isOpen || state.wrapper.classList.contains('is-disabled')) return;
            state.isOpen = true;
            state.wrapper.classList.add('is-open');
            state.menu.hidden = false;
            state.toggle.setAttribute('aria-expanded', 'true');
            state.menu.scrollTop = 0;
            state.focusIndex = -1;
            document.addEventListener('pointerdown', handleDocumentPointer, true);
            document.addEventListener('keydown', handleDocumentKeydown, true);
            requestAnimationFrame(() => focusSelected());
          }

          function buildMenu() {
            state.optionButtons.forEach((btn) => btn.remove());
            state.optionButtons = [];

            Array.from(select.options).forEach((option, index) => {
              const button = document.createElement('button');
              button.type = 'button';
              button.className = 'custom-select-option';
              button.dataset.value = option.value;
              button.textContent = option.textContent;
              button.disabled = option.disabled;
              button.setAttribute('role', 'option');
              button.setAttribute('aria-selected', option.selected ? 'true' : 'false');
              button.addEventListener('click', () => {
                if (option.disabled) return;
                select.value = option.value;
                select.dispatchEvent(new Event('change', { bubbles: true }));
                refreshLabel();
                syncSelectedClass();
                closeMenu({ focusToggle: true });
              });
              button.addEventListener('mouseover', () => {
                state.focusIndex = index;
              });
              state.optionButtons.push(button);
              state.menu.appendChild(button);
            });

            syncSelectedClass();
          }

          function handleToggleKeydown(event) {
            const { key } = event;
            if (key === 'ArrowDown' || key === 'ArrowUp' || key === ' ' || key === 'Enter') {
              event.preventDefault();
              if (!state.isOpen) {
                openMenu();
              } else if (key === 'ArrowDown') {
                focusOption(state.focusIndex + 1);
              } else if (key === 'ArrowUp') {
                focusOption(state.focusIndex - 1);
              }
            }
          }

          function handleMenuKeydown(event) {
            const { key } = event;
            if (key === 'Escape') {
              event.preventDefault();
              closeMenu({ focusToggle: true });
            } else if (key === 'ArrowDown') {
              event.preventDefault();
              focusOption(state.focusIndex + 1);
            } else if (key === 'ArrowUp') {
              event.preventDefault();
              focusOption(state.focusIndex - 1);
            } else if (key === 'Home') {
              event.preventDefault();
              focusOption(0);
            } else if (key === 'End') {
              event.preventDefault();
              focusOption(state.optionButtons.length - 1);
            } else if (key === 'Enter' || key === ' ') {
              event.preventDefault();
              const target = state.optionButtons[state.focusIndex];
              if (target && !target.disabled) {
                target.click();
              }
            }
          }

          function handleDocumentPointer(event) {
            if (!wrapper.contains(event.target)) {
              closeMenu();
            }
          }

          function handleDocumentKeydown(event) {
            if (event.key === 'Tab') {
              closeMenu();
            }
          }

          function syncDisabled() {
            const disabled = select.disabled;
            state.wrapper.classList.toggle('is-disabled', disabled);
            state.toggle.disabled = disabled;
          }

          toggle.addEventListener('click', () => {
            if (state.isOpen) {
              closeMenu({ focusToggle: true });
            } else {
              openMenu();
            }
          });
          toggle.addEventListener('keydown', handleToggleKeydown);
          menu.addEventListener('keydown', handleMenuKeydown);

          const optionObserver = new MutationObserver(() => {
            buildMenu();
            refreshLabel();
          });
          optionObserver.observe(select, { childList: true });

          const attributeObserver = new MutationObserver(() => {
            syncDisabled();
          });
          attributeObserver.observe(select, { attributes: true, attributeFilter: ['disabled'] });

          state.observers.push(optionObserver, attributeObserver);

          customSelectRegistry.set(select, {
            state,
            refreshLabel,
            syncDisabled,
            syncSelectedClass,
            setPlaceholder(placeholderText) {
              state.placeholder = placeholderText || '';
              if (!select.value) {
                state.label.textContent = state.placeholder;
              }
            },
          });

          refreshLabel();
          syncDisabled();
          buildMenu();
        }

        function updateCustomSelectPlaceholder(select, placeholderText) {
          const entry = customSelectRegistry.get(select);
          if (!entry) return;
          entry.state.placeholder = placeholderText || '';
          if (!select.value) {
            entry.state.label.textContent = entry.state.placeholder;
          }
          entry.syncSelectedClass();
        }

        function syncCustomSelectDisabled(select) {
          const entry = customSelectRegistry.get(select);
          if (!entry) return;
          entry.syncDisabled();
        }

        function refreshCustomSelect(select) {
          const entry = customSelectRegistry.get(select);
          if (!entry) return;
          entry.refreshLabel();
          entry.syncSelectedClass();
        }

        const modeRadios = Array.from(document.querySelectorAll('input[name="mode"]'));
        const productDetailField = document.getElementById('product-detail-field');
        const productDetailInput = document.getElementById('product_detail');
        const taglineDetailField = document.getElementById('tagline-detail-field');
        const taglineDetailInput = document.getElementById('tagline_detail');

        const personaPerCombinationInput = document.getElementById('persona_per_combination');
        const interviewsPerPersonaInput = document.getElementById('interviews_per_persona');
        const personaPromptTemplateInput = document.getElementById('persona_prompt_template');
        const interviewQuestionsInput = document.getElementById('interview_questions');
        const productCategoryInput = document.getElementById('product_category');
        const countryRegionInput = document.getElementById('country_region');

        const imageInput = document.getElementById('manual_images');
        const imageDropzone = document.getElementById('image-dropzone');
        const imagePreview = document.getElementById('image-preview');
        const imageDataTransfer = new DataTransfer();

        const jobSection = document.getElementById('job-section');
        const jobIdEl = document.getElementById('job-id');
        const jobStageEl = document.getElementById('job-stage');
        const jobMessageEl = document.getElementById('job-message');
        const jobMetricsEl = document.getElementById('job-metrics');
        const jobArtifactsEl = document.getElementById('job-artifacts');

        Object.values(sheetSelects).forEach((select) => setupCustomSelect(select));

        let currentJobId = null;
        let pollTimer = null;

        function stopPolling() {
          if (pollTimer) {
            clearTimeout(pollTimer);
            pollTimer = null;
          }
        }

        function syncModeFields() {
          const active = modeRadios.find((radio) => radio.checked)?.value || 'product';
          const isProduct = active === 'product';
          productDetailField.style.display = isProduct ? '' : 'none';
          taglineDetailField.style.display = isProduct ? 'none' : '';
        }
        modeRadios.forEach((radio) => radio.addEventListener('change', syncModeFields));
        syncModeFields();

        function populateSheetSelect(select, sheets) {
          const current = select.dataset.default || select.value || '';
          select.innerHTML = '';
          const ensureOption = (value) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
          };
          ensureOption(current || select.dataset.default || '');
          sheets.forEach((sheet) => {
            if (![...select.options].some((opt) => opt.value === sheet.sheet_name)) {
              ensureOption(sheet.sheet_name);
            }
          });
          select.value = current || select.dataset.default;
          refreshCustomSelect(select);
          syncCustomSelectDisabled(select);
        }

        async function handleSetSheets() {
          const url = spreadsheetUrlInput.value.trim();
          if (!url) {
            alert('スプレッドシート URL / ID を入力してください');
            return;
          }
          const prevText = setButton.textContent;
          setButton.disabled = true;
          setButton.textContent = '取得中...';
          sheetStatus.textContent = 'シート一覧を取得中...';
          try {
            const res = await fetch('/sheets/list', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ spreadsheet_url: url }),
            });
            const data = await res.json().catch(() => null);
            if (!res.ok || !data || !data.ok) {
              throw new Error((data && data.message) || 'シート一覧の取得に失敗しました');
            }
            const sheets = Array.isArray(data.sheets) ? data.sheets : [];
            Object.values(sheetSelects).forEach((select) => populateSheetSelect(select, sheets));
            sheetStatus.textContent = 'シート一覧を読み込みました。必要に応じて選択してください。';
          } catch (err) {
            sheetStatus.textContent = err instanceof Error ? err.message : 'シート一覧の取得に失敗しました';
          } finally {
            setButton.disabled = false;
            setButton.textContent = prevText;
          }
        }
        setButton.addEventListener('click', () => { void handleSetSheets(); });

        function appendImages(files) {
          if (!files) return;
          Array.from(files).forEach((file) => {
            if (!(file instanceof File) || !file.type.startsWith('image/')) {
              return;
            }
            imageDataTransfer.items.add(file);
            const card = document.createElement('div');
            card.className = 'image-card';

            const preview = document.createElement('img');
            preview.src = URL.createObjectURL(file);
            preview.alt = file.name;
            preview.addEventListener('load', () => URL.revokeObjectURL(preview.src));
            card.appendChild(preview);

            const meta = document.createElement('div');
            meta.className = 'muted';
            meta.textContent = file.name;
            card.appendChild(meta);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.addEventListener('click', () => {
              const dt = new DataTransfer();
              Array.from(imageDataTransfer.files).forEach((f) => {
                if (f !== file) {
                  dt.items.add(f);
                }
              });
              imageDataTransfer.items.clear();
              Array.from(dt.files).forEach((f) => imageDataTransfer.items.add(f));
              card.remove();
              imageInput.files = imageDataTransfer.files;
            });
            card.appendChild(removeBtn);

            imagePreview.appendChild(card);
          });
          imageInput.files = imageDataTransfer.files;
        }

        imageDropzone.addEventListener('click', () => {
          imageInput.click();
        });
        imageDropzone.addEventListener('dragover', (event) => {
          event.preventDefault();
          imageDropzone.classList.add('dragover');
        });
        imageDropzone.addEventListener('dragleave', (event) => {
          event.preventDefault();
          imageDropzone.classList.remove('dragover');
        });
        imageDropzone.addEventListener('drop', (event) => {
          event.preventDefault();
          imageDropzone.classList.remove('dragover');
          appendImages(event.dataTransfer ? event.dataTransfer.files : null);
        });
        imageDropzone.addEventListener('paste', (event) => {
          appendImages(event.clipboardData ? event.clipboardData.files : null);
        });
        imageInput.addEventListener('change', (event) => {
          appendImages(event.target.files);
          event.target.value = '';
        });

        async function pollStatus(jobId) {
          try {
            const res = await fetch(`/tribe-interview/jobs/${jobId}`);
            if (!res.ok) {
              throw new Error('ステータス取得に失敗しました');
            }
            const data = await res.json();
            renderStatus(data);
            if (data.status === 'running') {
              pollTimer = setTimeout(() => pollStatus(jobId), 2500);
            }
          } catch (err) {
            jobMessageEl.textContent = err instanceof Error ? err.message : 'ステータス取得に失敗しました';
            stopPolling();
          }
        }

        function renderMetrics(metrics) {
          jobMetricsEl.innerHTML = '';
          if (!metrics) {
            jobMetricsEl.textContent = 'メトリクスはまだありません。';
            return;
          }
          Object.entries(metrics).forEach(([key, value]) => {
            const row = document.createElement('div');
            row.textContent = `${key}: ${value}`;
            jobMetricsEl.appendChild(row);
          });
        }

        function renderArtifacts(artifacts) {
          jobArtifactsEl.innerHTML = '';
          if (!artifacts) {
            jobArtifactsEl.textContent = '成果物はまだありません。';
            return;
          }
          Object.entries(artifacts).forEach(([key, value]) => {
            const row = document.createElement('div');
            row.textContent = `${key}: ${value}`;
            jobArtifactsEl.appendChild(row);
          });
        }

        function renderStatus(state) {
          if (!state) return;
          const stageLabels = {
            pending: '待機中',
            tribe: 'Tribe 生成中',
            combination: '組合せ生成中',
            persona: 'ペルソナ生成中',
            qa: 'インタビュー生成中',
            embedding: 'Embedding 生成中',
          };

          jobSection.style.display = 'block';
          jobIdEl.textContent = state.job_id;
          jobStageEl.textContent = `ステータス: ${stageLabels[state.stage] || state.stage} / ${state.status}`;
          jobMessageEl.textContent = state.message || '';
          renderMetrics(state.metrics);
          renderArtifacts(state.artifacts);

          if (state.status !== 'running') {
            stopPolling();
          }
        }

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          stopPolling();

          const spreadsheetUrl = spreadsheetUrlInput.value.trim();
          if (!spreadsheetUrl) {
            alert('スプレッドシート URL / ID を入力してください');
            return;
          }

          const personaCount = parseInt(personaPerCombinationInput.value || '3', 10);
          if (Number.isNaN(personaCount) || personaCount < 1 || personaCount > 10) {
            alert('ペルソナ数は 1〜10 の範囲で入力してください');
            return;
          }
          const interviewCount = parseInt(interviewsPerPersonaInput.value || '3', 10);
          if (Number.isNaN(interviewCount) || interviewCount < 1 || interviewCount > 10) {
            alert('インタビュー数は 1〜10 の範囲で入力してください');
            return;
          }

          const fd = new FormData();
          fd.set('product_category', productCategoryInput.value.trim());
          fd.set('country_region', countryRegionInput.value.trim());

          const modeValue = modeRadios.find((radio) => radio.checked)?.value || 'product';
          fd.set('mode', modeValue);

          fd.set('persona_per_combination', String(personaCount));
          fd.set('interviews_per_persona', String(interviewCount));
          fd.set('spreadsheet_url', spreadsheetUrl);

          fd.set('tribe_sheet_name', sheetSelects.tribe.value || sheetSelects.tribe.dataset.default || 'Tribe_SetUp');
          fd.set('combination_sheet_name', sheetSelects.combination.value || sheetSelects.combination.dataset.default || 'Tribe_Combination');
          fd.set('persona_sheet_name', sheetSelects.persona.value || sheetSelects.persona.dataset.default || 'Persona_SetUp');
          fd.set('qa_llm_sheet_name', sheetSelects.qaLLM.value || sheetSelects.qaLLM.dataset.default || 'QA_LLM');
          fd.set('qa_embedding_sheet_name', sheetSelects.qaEmbedding.value || sheetSelects.qaEmbedding.dataset.default || 'QA_Embedding');

          fd.set('product_detail', modeValue === 'product' ? (productDetailInput.value || '').trim() : '');
          fd.set('tagline_detail', modeValue === 'communication' ? (taglineDetailInput.value || '').trim() : '');
          fd.set('persona_prompt_template', (personaPromptTemplateInput.value || '').trim());
          fd.set('interview_questions', (interviewQuestionsInput.value || '').trim());

          Array.from(imageDataTransfer.files).forEach((file) => {
            fd.append('manual_images', file, file.name);
          });

          try {
            const res = await loadingOverlay.run(() => fetch('/tribe-interview/jobs', { method: 'POST', body: fd }));
            if (!res.ok) {
              const text = await res.text();
              throw new Error(text || 'ジョブ生成に失敗しました');
            }
            const data = await res.json();
            currentJobId = data.job_id;
            jobSection.style.display = 'block';
            jobStageEl.textContent = 'ステータス: 実行開始';
            jobMessageEl.textContent = 'パイプラインを初期化しています...';
            jobMetricsEl.innerHTML = '';
            jobArtifactsEl.innerHTML = '';
            pollStatus(currentJobId);
          } catch (err) {
            alert(err instanceof Error ? err.message : 'ジョブ生成に失敗しました');
          }
        });
      })();
    </script>
  </body>
</html>

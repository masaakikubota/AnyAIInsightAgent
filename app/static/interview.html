<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>AnyAI Interview — 合成消費者ヒアリング</title>
    <link rel="icon" href="/static/anyai/assets/AnyAI_icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/anyai/core/anyai.tokens.css" />
    <link rel="stylesheet" href="/static/anyai/core/anyai.components.css" />
    <link rel="stylesheet" href="/static/anyai/core/anyai.utilities.css" />
    <link rel="stylesheet" href="/static/anyai/tool-layout.css" />
    <script defer src="/static/anyai/vendor/lucide.js"></script>
    <script defer src="/static/anyai/sidebar.js"></script>
    <style>
      body { font-family: 'Noto Sans JP', sans-serif; }
      .layout { display:flex; flex-direction:column; min-height:100vh; }
      .anyai-content { flex:1; display:flex; justify-content:center; padding: var(--anyai-space-5); }
      .container { width: min(880px, 100%); display:flex; flex-direction:column; gap: var(--anyai-space-4); }
      .card { padding: var(--anyai-space-4); border-radius: 18px; background: var(--anyai-panel); box-shadow: var(--anyai-shadow-sm); }
      .stack { display:flex; flex-direction:column; gap: var(--anyai-space-4); }
      .stack-sm { display:flex; flex-direction:column; gap: 8px; }
      .grid { display:grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
      .field { display:flex; flex-direction:column; gap: 6px; }
      label { font-weight: 600; font-size: var(--anyai-fs-2); }
      input[type="text"], input[type="number"], textarea, select {
        width:100%; padding:10px; border-radius:10px; border:1px solid var(--anyai-border); background:var(--anyai-panel);
      }
      textarea { min-height: 132px; }
      progress { width:100%; height:12px; }
      .muted { color: var(--anyai-text-subtle); font-size: var(--anyai-fs-2); }
      code { font-family: 'JetBrains Mono', monospace; }
      ul { margin:0; padding-left:18px; }
      .dropzone {
        border: 1px dashed var(--anyai-border-strong);
        border-radius: 12px;
        padding: var(--anyai-space-3);
        text-align: center;
        background: var(--anyai-surface);
        cursor: pointer;
        transition: border-color 0.2s ease;
      }
      .dropzone.dragover {
        border-color: var(--anyai-primary);
      }
      .dropzone-list {
        display:flex;
        flex-direction:column;
        gap:4px;
        margin-top:8px;
        text-align:left;
        font-size: var(--anyai-fs-2);
      }
      .hidden { display:none !important; }
      fieldset { border:none; padding:0; margin:0; }
      legend { font-weight:700; font-size:var(--anyai-fs-3); margin-bottom:12px; }
      details.sheet-advanced { border:1px solid var(--anyai-border); border-radius:12px; padding:var(--anyai-space-3); background:var(--anyai-surface); }
      details.sheet-advanced[open] { background:var(--anyai-panel); }
      @media (max-width: 720px) {
        .anyai-content { padding: var(--anyai-space-3); }
      }
    </style>
  </head>
  <body class="layout">
    <header class="anyai-header">
      <div class="anyai-header__branding">
        <a class="anyai-brand" href="/" aria-label="AnyAI InsightAgent ホーム">
          <img src="/static/anyai/assets/AnyAI_logo.png" alt="AnyAI ロゴ">
          <span class="anyai-brand__name">AnyAI InsightAgent</span>
        </a>
        <p class="anyai-brand__title">AnyAI Interview</p>
      </div>
      <nav class="anyai-nav" aria-label="AnyAI プロダクト">
        <a class="anyai-nav__link" href="/">AnyAI Scoring</a>
        <a class="anyai-nav__link" href="/cleansing">AnyAI Cleansing</a>
        <a class="anyai-nav__link is-active" aria-current="page" href="/interview">AnyAI Interview</a>
        <a class="anyai-nav__link" href="/persona">Persona Seeds</a>
        <a class="anyai-nav__link" href="/dashboard">Persona Dashboard</a>
        <a class="anyai-nav__link" href="/video-analysis">Video Analysis</a>
        <a class="anyai-nav__link" href="/comment-enhancer">Comment Enhancer</a>
        <a class="anyai-nav__link" href="/video-comment-review">Video Comment Review</a>
        <a class="anyai-nav__link" href="/kol-reviewer">KOL Reviewer</a>
      </nav>
      <div class="anyai-header__actions" aria-label="クイック操作">
        <button type="button" class="anyai-icon-button" aria-label="テーマを切り替え">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="1.5" />
            <path d="M12 3v2m0 14v2m9-9h-2M5 12H3m16.364-7.364-1.414 1.414M7.05 16.95l-1.414 1.414m0-12.728 1.414 1.414m9.9 9.9 1.414 1.414" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <button type="button" class="anyai-icon-button" aria-label="サイト内検索を開く">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle cx="11" cy="11" r="6" fill="none" stroke="currentColor" stroke-width="1.5" />
            <path d="m20 20-3.5-3.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <button type="button" class="anyai-icon-button" aria-label="アカウントメニューを開く">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" fill="none" stroke="currentColor" stroke-width="1.5" />
            <path d="M5 20.5a7 7 0 0 1 14 0" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
      </div>
    </header>

    <div class="anyai-layout">
      <aside class="anyai-sidebar" data-active-tool="interview"></aside>
      <main class="anyai-content">
        <div class="container">
        <h1 class="mt-0" style="margin:0;">合成消費者インタビューを自動生成</h1>
        <section class="card" aria-labelledby="interview-guide-title">
          <div class="stack-sm">
            <h2 id="interview-guide-title" style="margin:0;">出力サマリと前提</h2>
            <ul class="muted" style="gap:4px;display:flex;flex-direction:column;font-size:var(--anyai-fs-2);">
              <li>トライブ概要は <code>Tribe_SetUp</code> タブ（B列以降）へ書き込み、10件ごとに同一 <code>SessionID</code> を割り当てます。</li>
              <li>ペルソナ要約は <code>Persona_SetUp</code> タブ A/B 列に出力され、共通質問・SessionID を含んだ要約を保存します。</li>
              <li>インタビュー回答は <code>QA_Answer</code> / <code>QA_Embedded</code> など既存タブへ連携され、ダッシュボード生成に利用できます。</li>
              <li><code>max_rounds</code> は質問数と一致させる必要があります（UI で自動同期）。質問数を変更した場合は出力ラウンド数も同期されます。</li>
            </ul>
          </div>
        </section>
        <div class="card">
          <form id="interview-form" class="stack" enctype="multipart/form-data">
            <fieldset class="stack">
              <legend>基本情報</legend>
              <div class="grid">
                <div class="field">
                  <label for="project_name">プロジェクト名</label>
                  <input type="text" id="project_name" name="project_name" placeholder="例: 2025Q4 Haircare Launch" required />
                </div>
                <div class="field">
                  <label for="domain">ドメイン / カテゴリ</label>
                  <input type="text" id="domain" name="domain" placeholder="例: haircare" required />
                </div>
                <div class="field">
                  <label for="country_region">Country / Region</label>
                  <input type="text" id="country_region" name="country_region" placeholder="例: JP_Kanto または Japan_Tokyo" />
                </div>
              </div>
              <div class="grid">
                <div class="field">
                  <label for="concurrency">同時実行</label>
                  <input type="number" id="concurrency" name="concurrency" value="20" min="1" max="200" />
                </div>
              </div>
            </fieldset>

            <fieldset class="stack">
              <legend>Google Sheets 出力</legend>
              <p class="muted">
                スプレッドシート内に <code>Tribe_SetUp</code> / <code>Persona_SetUp</code> / <code>QA_Answer</code> などのタブが存在していることを確認してください。
              </p>
              <div class="field">
                <label for="persona_sheet_url">ペルソナ出力先シートURL/ID</label>
                <input type="text" id="persona_sheet_url" name="persona_sheet_url" placeholder="未指定の場合は刺激シートを使用" />
                <div class="muted">共有対象の Google Sheets の URL またはスプレッドシート ID を入力してください。</div>
              </div>
            </fieldset>

            <fieldset class="stack">
              <legend>刺激設定</legend>
              <div class="field">
                <label>刺激入力モード</label>
                <div class="stack-sm" style="flex-direction:row; flex-wrap:wrap; gap:12px;">
                  <label><input type="radio" name="stimuli_input_mode" value="manual" checked /> 手動入力</label>
                  <label><input type="radio" name="stimuli_input_mode" value="sheet" /> Google Sheets から取得</label>
                </div>
                <div class="muted">Google Sheets を選択すると、指定シートの1列目から刺激一覧を取得します。</div>
              </div>
              <div id="manual-stimuli-section" class="stack">
                <div class="field">
                  <label for="stimuli_source">商品コンセプト（テキスト）</label>
                  <textarea id="stimuli_source" name="stimuli_source" placeholder="例: スカルプケア美容液
頭皮マッサージブラシ"></textarea>
                </div>
                <div class="field">
                  <label>画像刺激（任意）</label>
                  <div id="stimuli-image-dropzone" class="dropzone" tabindex="0">
                    <strong>画像をここにドロップ / ペースト / クリックして選択</strong>
                    <p class="muted" style="margin:4px 0 0;">PNG・JPEG など複数可。テキストと併用できます。</p>
                  </div>
                  <input type="file" id="manual_stimuli_images" name="manual_stimuli_images" accept="image/*" multiple hidden />
                  <div id="stimuli-image-list" class="dropzone-list"></div>
                </div>
              </div>
              <div id="sheet-stimuli-section" class="stack" style="display:none;">
                <div class="field">
                  <label for="stimuli_sheet_url">Google Sheets URL / ID</label>
                  <input type="text" id="stimuli_sheet_url" name="stimuli_sheet_url" placeholder="https://docs.google.com/spreadsheets/d/..." />
                  <div class="muted">閲覧可能なURLまたはスプレッドシートIDを指定してください。</div>
                </div>
                <div class="grid">
                  <div class="field">
                    <label for="stimuli_sheet_name">シート名（任意）</label>
                    <input type="text" id="stimuli_sheet_name" name="stimuli_sheet_name" placeholder="例: Stimuli" />
                  </div>
                  <div class="field">
                    <label for="stimuli_sheet_column">対象列（A〜Z）</label>
                    <input type="text" id="stimuli_sheet_column" name="stimuli_sheet_column" value="A" maxlength="3" />
                  </div>
                  <div class="field">
                    <label for="stimuli_sheet_start_row">開始行</label>
                    <input type="number" id="stimuli_sheet_start_row" name="stimuli_sheet_start_row" value="2" min="1" />
                  </div>
                </div>
              </div>
            </fieldset>

            <fieldset class="stack">
              <legend>トライブ &amp; ペルソナ設定</legend>
              <div class="grid">
                <div class="field">
                  <label for="persona_count">総ペルソナ数</label>
                  <input type="number" id="persona_count" name="persona_count" value="30" min="1" max="500" readonly />
                  <div class="muted">トライブ数 × トライブ毎のペルソナ数で自動計算</div>
                </div>
                <div class="field">
                  <label for="tribe_count">トライブ数</label>
                  <input type="number" id="tribe_count" name="tribe_count" value="10" min="1" max="200" />
                </div>
                <div class="field">
                  <label for="persona_per_tribe">トライブ毎のペルソナ数</label>
                  <input type="number" id="persona_per_tribe" name="persona_per_tribe" value="3" min="1" max="50" />
                </div>
                <div class="field">
                  <label for="questions_per_persona">ペルソナへの質問数</label>
                  <input type="number" id="questions_per_persona" name="questions_per_persona" value="5" min="1" max="30" />
                  <div class="muted">QAラウンド数と同一です。変更すると <code>max_rounds</code> も同期されます。</div>
                </div>
              </div>
              <input type="hidden" id="max_rounds" name="max_rounds" value="5" />
              <div class="field">
                <label for="persona_template">ペルソナテンプレ概要（任意）</label>
                <textarea id="persona_template" name="persona_template" placeholder="例: 忙しい都市生活者で、エシカル/低刺激なヘアケアを重視"></textarea>
              </div>
              <div class="field" style="flex-direction:row; gap:8px; align-items:center;">
                <input type="checkbox" id="enable_tribe_learning" name="enable_tribe_learning" />
                <label for="enable_tribe_learning" style="margin:0;">発話CSVからトライブカテゴリを提案する</label>
              </div>
              <div class="field">
                <input type="file" id="utterance_csv" name="utterance_csv" accept=".csv" disabled />
                <div class="muted">CSVの1列目に自由発話を記載してください（UTF-8推奨）。アップロードすると初期トライブカテゴリを自動推定します。</div>
              </div>
            </fieldset>

            <fieldset class="stack">
              <legend>補足メモ</legend>
              <div class="field">
                <label for="notes">補足メモ（LLMへのトーン指示など）</label>
                <textarea id="notes" name="notes" placeholder="例: ステレオタイプを避け、具体的な生活描写を優先してください。"></textarea>
              </div>
            </fieldset>
            <button class="btn btn-primary" type="submit">インタビュー生成を開始</button>
          </form>

        <section id="job-section" class="card" style="display:none;">
          <div class="stack-sm">
            <div>ジョブID: <code id="job-id"></code></div>
            <div class="muted" id="job-status"></div>
            <progress id="persona-progress" value="0" max="100"></progress>
            <div class="muted" id="persona-counts"></div>
            <div class="muted" id="transcript-counts"></div>
            <div id="job-message"></div>
            <div id="artifact-list" class="muted"></div>
          </div>
        </section>
        </div>
      </main>
    </div>

    <script>
      const form = document.getElementById('interview-form');
      const jobSection = document.getElementById('job-section');
      const jobIdEl = document.getElementById('job-id');
      const jobStatusEl = document.getElementById('job-status');
      const personaProgress = document.getElementById('persona-progress');
      const personaCounts = document.getElementById('persona-counts');
      const transcriptCounts = document.getElementById('transcript-counts');
      const jobMessage = document.getElementById('job-message');
      const artifactList = document.getElementById('artifact-list');
      const stimuliModeRadios = document.querySelectorAll('input[name="stimuli_input_mode"]');
      const manualStimuliSection = document.getElementById('manual-stimuli-section');
      const sheetStimuliSection = document.getElementById('sheet-stimuli-section');
      const sheetColumnInput = document.getElementById('stimuli_sheet_column');
      const sheetStartRowInput = document.getElementById('stimuli_sheet_start_row');
      const personaSheetNameInput = document.getElementById('persona_sheet_name');
      const personaOverviewColumnInput = document.getElementById('persona_overview_column');
      const personaPromptColumnInput = document.getElementById('persona_prompt_column');
      const personaStartRowInput = document.getElementById('persona_start_row');
      const personaCountInput = document.getElementById('persona_count');
      const maxRoundsInput = document.getElementById('max_rounds');
      const tribeToggle = document.getElementById('enable_tribe_learning');
      const tribeCsvInput = document.getElementById('utterance_csv');
      const tribeCountInput = document.getElementById('tribe_count');
      const personaPerTribeInput = document.getElementById('persona_per_tribe');
      const questionsPerPersonaInput = document.getElementById('questions_per_persona');
      const imageInput = document.getElementById('manual_stimuli_images');
      const imageDropZone = document.getElementById('stimuli-image-dropzone');
      const imageList = document.getElementById('stimuli-image-list');

      const imageDataTransfer = new DataTransfer();
      const imageSignatureSet = new Set();

      let currentJobId = null;
      let pollTimer = null;

      function stopPolling() {
        if (pollTimer) {
          clearTimeout(pollTimer);
          pollTimer = null;
        }
      }

      async function fetchStatus(jobId) {
        const res = await fetch(`/interview/jobs/${jobId}`);
        if (!res.ok) {
          throw new Error('ステータス取得に失敗しました');
        }
        return res.json();
      }

      function renderStatus(state) {
        jobSection.style.display = 'block';
        jobIdEl.textContent = state.job_id;
        jobStatusEl.textContent = `ステータス: ${state.status} / ステージ: ${state.stage}`;
        jobMessage.textContent = state.message || '';

        const total = state.total_personas || 0;
        const generated = state.generated_personas || 0;
        personaProgress.value = total ? Math.floor((generated / total) * 100) : 0;
        personaCounts.textContent = total
          ? `ペルソナ生成 ${generated} / ${total}`
          : 'ペルソナ生成準備中';
        transcriptCounts.textContent = `生成済みインタビュー: ${state.processed_transcripts || 0}`;

        if (state.artifacts) {
          const items = Object.entries(state.artifacts)
            .map(([key, path]) => `<div><strong>${key}</strong>: <code>${path}</code></div>`)
            .join('');
          artifactList.innerHTML = items;
        } else {
          artifactList.innerHTML = '';
        }

        const stillRunning = state.status === 'pending' || state.status === 'running';
        if (stillRunning) {
          pollTimer = setTimeout(() => pollStatus(state.job_id), 2000);
        } else {
          stopPolling();
        }
      }

      function syncStimuliMode() {
        const active = Array.from(stimuliModeRadios).find((radio) => radio.checked)?.value || 'manual';
        const showSheet = active === 'sheet';
        if (manualStimuliSection) {
          manualStimuliSection.style.display = showSheet ? 'none' : 'block';
        }
        if (sheetStimuliSection) {
          sheetStimuliSection.style.display = showSheet ? 'flex' : 'none';
        }
        if (imageDropZone) {
          imageDropZone.classList.toggle('hidden', showSheet);
        }
        if (imageInput) {
          imageInput.disabled = showSheet;
        }
        if (showSheet) {
          imageDataTransfer.items.clear();
          imageSignatureSet.clear();
          if (imageList) {
            imageList.innerHTML = '';
          }
          if (imageInput) {
            imageInput.value = '';
            imageInput.files = imageDataTransfer.files;
          }
        }
      }

      stimuliModeRadios.forEach((radio) => {
        radio.addEventListener('change', syncStimuliMode);
      });
      syncStimuliMode();
      syncDerivedCounts();

      if (sheetColumnInput) {
        sheetColumnInput.addEventListener('blur', () => {
          sheetColumnInput.value = (sheetColumnInput.value || 'A').trim().toUpperCase();
        });
      }

      function normalizeColumnInput(input, fallback) {
        if (!input) return;
        input.addEventListener('blur', () => {
          const raw = (input.value || fallback).trim().toUpperCase();
          input.value = /^[A-Z]+$/.test(raw) ? raw : fallback;
        });
      }

      normalizeColumnInput(personaOverviewColumnInput, 'B');
      normalizeColumnInput(personaPromptColumnInput, 'C');
      if (tribeToggle && tribeCsvInput) {
        const syncTribeToggle = () => {
          if (tribeToggle.checked) {
            tribeCsvInput.removeAttribute('disabled');
          } else {
            tribeCsvInput.value = '';
            tribeCsvInput.setAttribute('disabled', '');
          }
        };
        tribeToggle.addEventListener('change', syncTribeToggle);
        syncTribeToggle();
      }

      function syncDerivedCounts() {
        if (!personaCountInput || !tribeCountInput || !personaPerTribeInput || !questionsPerPersonaInput) {
          return;
        }
        const tribeVal = Math.min(Math.max(parseInt(tribeCountInput.value || '10', 10) || 10, 1), 200);
        const personaVal = Math.min(Math.max(parseInt(personaPerTribeInput.value || '3', 10) || 3, 1), 50);
        const questionVal = Math.min(Math.max(parseInt(questionsPerPersonaInput.value || '5', 10) || 5, 1), 30);
        const total = Math.min(Math.max(tribeVal * personaVal, 1), 500);
        personaCountInput.value = String(total);
        if (maxRoundsInput) {
            maxRoundsInput.value = String(questionVal);
        }
      }

      if (tribeCountInput) {
        tribeCountInput.addEventListener('input', syncDerivedCounts);
        tribeCountInput.addEventListener('blur', syncDerivedCounts);
      }
      if (personaPerTribeInput) {
        personaPerTribeInput.addEventListener('input', syncDerivedCounts);
        personaPerTribeInput.addEventListener('blur', syncDerivedCounts);
      }
      if (questionsPerPersonaInput) {
        questionsPerPersonaInput.addEventListener('input', syncDerivedCounts);
        questionsPerPersonaInput.addEventListener('blur', syncDerivedCounts);
      }

      function appendImages(files) {
        if (!files) return;
        Array.from(files).forEach((file) => {
          if (!(file instanceof File) || !file.type.startsWith('image/')) {
            return;
          }
          const signature = `${file.name}-${file.lastModified}`;
          if (imageSignatureSet.has(signature)) {
            return;
          }
          imageSignatureSet.add(signature);
          imageDataTransfer.items.add(file);
          if (imageList) {
            const item = document.createElement('div');
            item.textContent = file.name;
            imageList.appendChild(item);
          }
        });
        if (imageInput) {
          imageInput.files = imageDataTransfer.files;
        }
      }

      if (imageInput) {
        imageInput.addEventListener('change', (event) => {
          appendImages(event.target.files);
          event.target.value = '';
        });
      }

      if (imageDropZone) {
        imageDropZone.addEventListener('click', () => {
          if (!imageInput || imageInput.disabled) return;
          imageInput.click();
        });
        imageDropZone.addEventListener('dragover', (event) => {
          event.preventDefault();
          imageDropZone.classList.add('dragover');
        });
        imageDropZone.addEventListener('dragleave', (event) => {
          event.preventDefault();
          imageDropZone.classList.remove('dragover');
        });
        imageDropZone.addEventListener('drop', (event) => {
          event.preventDefault();
          imageDropZone.classList.remove('dragover');
          appendImages(event.dataTransfer ? event.dataTransfer.files : null);
        });
        imageDropZone.addEventListener('paste', (event) => {
          appendImages(event.clipboardData ? event.clipboardData.files : null);
        });
      }

      async function pollStatus(jobId) {
        try {
          const state = await fetchStatus(jobId);
          renderStatus(state);
        } catch (err) {
          console.error(err);
          jobStatusEl.textContent = 'ステータス取得に失敗しました';
          stopPolling();
        }
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        stopPolling();
        syncDerivedCounts();
        const fd = new FormData(form);
        if (!fd.get('enable_tribe_learning')) {
          fd.set('enable_tribe_learning', 'false');
        } else {
          fd.set('enable_tribe_learning', 'true');
        }
        if (personaCountInput) {
          fd.set('persona_count', personaCountInput.value || '0');
        }
        if (tribeCountInput) {
          fd.set('tribe_count', tribeCountInput.value || '10');
        }
        if (personaPerTribeInput) {
          fd.set('persona_per_tribe', personaPerTribeInput.value || '3');
        }
        if (questionsPerPersonaInput) {
          fd.set('questions_per_persona', questionsPerPersonaInput.value || '5');
        }
        if (maxRoundsInput) {
          fd.set('max_rounds', maxRoundsInput.value || questionsPerPersonaInput.value || '5');
        }
        if (sheetColumnInput) {
          sheetColumnInput.value = (sheetColumnInput.value || 'A').trim().toUpperCase();
        }
        if (sheetStartRowInput) {
          const parsed = parseInt(sheetStartRowInput.value || '2', 10);
          sheetStartRowInput.value = Number.isNaN(parsed) || parsed < 1 ? '2' : String(parsed);
        }
        if (personaOverviewColumnInput) {
          personaOverviewColumnInput.value = (personaOverviewColumnInput.value || 'B').trim().toUpperCase();
        }
        if (personaPromptColumnInput) {
          personaPromptColumnInput.value = (personaPromptColumnInput.value || 'C').trim().toUpperCase();
        }
        if (personaStartRowInput) {
          const parsedPersona = parseInt(personaStartRowInput.value || '2', 10);
          personaStartRowInput.value = Number.isNaN(parsedPersona) || parsedPersona < 1 ? '2' : String(parsedPersona);
        }
        if (personaSheetNameInput) {
          personaSheetNameInput.value = (personaSheetNameInput.value || 'LLMSetUp').trim() || 'LLMSetUp';
        }
        try {
          const res = await fetch('/interview/jobs', { method: 'POST', body: fd });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'ジョブ生成に失敗しました');
          }
          const data = await res.json();
          currentJobId = data.job_id;
          jobSection.style.display = 'block';
          personaProgress.value = 0;
          personaCounts.textContent = '';
          transcriptCounts.textContent = '';
          jobStatusEl.textContent = 'ステータス: pending';
          jobMessage.textContent = 'インタビューパイプラインを起動しました。';
          artifactList.innerHTML = '';
          pollStatus(currentJobId);
        } catch (err) {
          alert(err.message || 'ジョブ生成に失敗しました');
        }
      });
    </script>
  </body>
</html>
